<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>费用查询 - AI智货代</title>
  
  <!-- SEO 元数据 -->
  <meta name="description" content="AI智货代 - 专业的海运费用查询平台，实时查询全球主要航线的海运费用。">
  <meta name="keywords" content="费用查询,海运费用,运费查询,海运报价,AI智货代,国际物流">
  <meta name="author" content="AI智货代">
  <meta name="robots" content="index, follow">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- 全局样式 -->
  <link rel="stylesheet" href="/assets/css/global.css">
  
  <!-- 自定义配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#0E2E88',
            accent: '#FF7D00',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .transition-custom {
        transition: all 0.3s ease;
      }
      .card-hover {
        @apply hover:shadow-lg hover:-translate-y-1 transition-custom;
      }
      .custom-gradient {
        background: linear-gradient(to right, 
          #3b82f6 0%, 
          #3b82f6 61.8%, 
          #14b8a6 80.9%, 
          #06b6d4 100%);
      }
      .text-gradient {
        background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706, #92400e);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .h2-gradient {
        background: linear-gradient(135deg, #165DFF 0%, #0E2E88 30%, #FF7D00 70%, #f59e0b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 200% 200%;
        animation: gradientShift 3s ease-in-out infinite;
      }
      @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

      /* 右向左滚动播报 */
      .marquee-rtl { animation: marqueeRTL 18s linear infinite; }
      @keyframes marqueeRTL {
        0% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
      }
      
      /* 统一按钮样式 */
      .btn-primary {
        @apply bg-primary text-white font-medium py-3 px-6 rounded-lg hover:bg-primary/90 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg;
      }
      
      .btn-secondary {
        @apply bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg;
      }
      
      .btn-accent {
        @apply bg-yellow-500 text-black font-medium py-2 px-4 rounded-lg hover:bg-yellow-400 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg;
      }
      
      /* 强制首页使用浅色背景 */
      body {
        background-color: #f9fafb !important;
      }
      
      /* 响应式设计优化 */
      @media (max-width: 767px) {
        .hero {
          @apply py-6 px-3;
        }
        .hero__title {
          @apply text-2xl leading-tight;
        }
        .hero__subtitle {
          @apply text-base;
        }
        .container {
          @apply px-3;
        }
        .tracking-section__form {
          @apply flex-col space-y-3;
        }
        .form__select {
          @apply w-full;
        }
      }
      
      @media (max-width: 480px) {
        .hero {
          @apply py-4 px-2;
        }
        .hero__title {
          @apply text-xl;
        }
        .container {
          @apply px-2;
        }
      }
    }
  </style>
  <!-- 全局JavaScript -->
  <script src="/assets/js/global.js?v=20251114"></script>
  <script>
    // 保存 URL 参数以供控件初始化后再预填
    (function(){
      try {
        const params = new URLSearchParams(location.search);
        const origin = params.get('origin') || '';
        const destination = params.get('destination') || '';
        const originCode = params.get('originCode') || '';
        const destCode = params.get('destCode') || '';
        window.__pricing_prefill = { origin, destination, originCode, destCode };
      } catch(e) { console.warn('pricing prefill init error', e); }
    })();
  </script>
</head>
<body class="bg-gray-50 font-sans text-dark">
  <!-- 页眉容器 -->
  <div id="header-container"></div>

  <main id="main">
    <!-- 全宽横幅 -->
    <section class="hero custom-gradient text-white py-8">
      <div class="container mx-auto px-4 text-left">
        <h1 class="hero__title text-[clamp(2rem,5vw,3.5rem)] font-bold mb-4 text-shadow">
          运费查询
        </h1>
        <p class="hero__subtitle text-[clamp(1rem,2vw,1.25rem)] max-w-3xl opacity-90">
          实时查询全球主要航线的海运费用，帮助您更好地控制物流成本。
        </p>
      </div>
    </section>
    <!-- 头部下方滚动播报 -->
    <section class="bg-white border-b">
      <div class="container mx-auto px-4 py-3">
        <div class="overflow-hidden relative h-8">
          <div class="marquee-rtl whitespace-nowrap absolute right-0">
            <span class="text-gradient text-[clamp(1rem,2vw,1.25rem)]">最新运价播报：亚洲→北美高柜下调50美金；欧洲线旺季附加费调整；东南亚短途加班船期增加，欢迎查询！</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 主内容容器 -->
    <section class="container mx-auto px-4 py-8">
      <div class="flex flex-col md:flex-row gap-6 md:gap-8">
        <!-- 左侧容器 - 占3/4宽度 -->
        <div class="w-full md:w-3/4 space-y-6">
          <!-- 运费查询（仅起运港/目的港 + 查询按钮） + 右侧特价板块 -->
          <div class="tracking-section bg-white rounded-lg shadow-sm p-6 border border-purple-500">
            <div class="flex items-stretch justify-between gap-4 mb-4 flex-wrap">
              <h2 class="tracking-section__title text-2xl font-bold h2-gradient m-0">海运费用查询</h2>
              <!-- 右侧：特价滚动播报，与 h2 同行且高度一致 -->
              <div class="flex-1 md:flex-none">
                <div class="overflow-hidden">
                  <div class="marquee-rtl whitespace-nowrap inline-flex items-center h-full px-3 border border-red-200 rounded-md bg-gradient-to-r from-red-50 via-yellow-50 to-white shadow-sm text-xs sm:text-sm">
                    <i class="fas fa-fire mr-2 text-red-500"></i>
                    <span class="text-gray-800">天津 → 雅加达 | 20GP 现舱特价</span>
                    <span class="ml-2 font-extrabold text-red-600">USD 950</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-1 gap-4 items-start">
              <!-- 左侧：查询表单（更美观的一行排布） -->
              <div class="col-span-1">
                <div class="tracking-section__form flex flex-wrap justify-center items-center gap-3 md:gap-4">
                  <div>
                    <!-- 起运港改为下拉选择 -->
                    <select id="pricing-origin" class="form__input w-56 md:w-64 h-10 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
                      <option value="" selected>请选择起运港</option>
                      <!-- 选项由脚本根据本地库自动填充 -->
                    </select>
                  </div>
                  <div>
                    <!-- 目的港支持模糊匹配与联想菜单 -->
                    <input id="pricing-dest" type="text" placeholder="请输入目的港（支持中文/英文/代码模糊匹配）" list="pricing-dest-list" class="form__input w-56 md:w-64 h-10 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"/>
                    <datalist id="pricing-dest-list"></datalist>
                  </div>
                  <div class="flex items-center">
                    <button id="pricing-search-btn" class="btn-primary h-10 px-6 flex items-center justify-center whitespace-nowrap text-sm">
                      <i class="fas fa-search mr-1"></i>
                      <span>运费查询</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 运费报价（默认显示全部，查询后显示筛选结果） -->
          <!-- 局部样式：压缩表格字体与内边距，禁用换行（单行显示），超出使用省略号 -->
          <style>
            #quotes-section table { table-layout: fixed; width: 100%; font-size: 12px; }
            #quotes-section thead th { font-size: 12px; }
            #quotes-section table th, #quotes-section table td {
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              padding: 6px 10px; /* 压缩内边距，避免换行 */
              line-height: 1.3;
              text-align: center; /* 所有内容居中显示 */
            }
            /* 序号列更窄一些 */
            #quotes-section table thead th:nth-child(1),
            #quotes-section table tbody td:nth-child(1) {
              width: 6%;
            }
            /* 可选：为备注列稍微扩展宽度（在固定布局下更易单行显示）*/
            #quotes-section table thead th:nth-child(10),
            #quotes-section table tbody td:nth-child(10) { /* 备注列 */
              width: 18%;
            }
            /* 船公司列设置固定宽度以确保缩写/名称单行 */
            #quotes-section table thead th:nth-child(6),
            #quotes-section table tbody td:nth-child(6) { /* 船公司列 */
              width: 12%;
            }
          </style>
          <div id="quotes-section" class="bg-white rounded-lg shadow-sm p-6 border border-blue-500">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold h2-gradient">运费报价</h2>
              <div class="flex items-center gap-3">
                <div id="quotes-count" class="text-sm text-gray-600">共 0 条记录，每页 20 条</div>
                <button id="batch-quote-btn" class="btn-primary px-3 py-1 text-sm disabled:opacity-50" disabled>
                  <i class="fas fa-file-invoice mr-1"></i>生成报价单
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white border border-gray-200">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="py-2 px-4 border-b text-left">序号</th>
                    <th class="py-2 px-4 border-b text-left">起运港</th>
                    <th class="py-2 px-4 border-b text-left">目的港</th>
                    <th class="py-2 px-4 border-b text-left">20GP</th>
                    <th class="py-2 px-4 border-b text-left">40GP/40HQ</th>
                    <th class="py-2 px-4 border-b text-left">船公司</th>
                    <th class="py-2 px-4 border-b text-left">船期</th>
                    <th class="py-2 px-4 border-b text-left">航程</th>
                    <th class="py-2 px-4 border-b text-left">直航/中转</th>
                    <th class="py-2 px-4 border-b text-left">备注</th>
                  </tr>
                </thead>
                <tbody id="quotes-tbody">
                  <!-- 数据行由脚本插入 -->
                </tbody>
              </table>
            </div>
            <div class="mt-4 flex items-center justify-end">
              <div class="space-x-2">
                <button id="prev-page" class="btn-secondary px-3 py-1 text-sm">上一页</button>
                <span id="page-info" class="text-sm text-gray-700 align-middle"></span>
                <button id="next-page" class="btn-secondary px-3 py-1 text-sm">下一页</button>
              </div>
            </div>
          </div>
          <!-- 新增：运费走势与运价对比（左右排列） -->
          <div class="flex flex-col md:flex-row gap-6">
            <!-- 运费走势（折线图） -->
            <div id="trend-section" class="bg-white rounded-lg shadow-sm p-6 border border-purple-500 w-full md:w-1/2">
              <div class="flex items-center justify-between mb-4">
                <h2 id="trend-title" class="text-2xl font-bold h2-gradient">运费走势</h2>
                <div class="text-sm text-gray-600">最近一段时间的运费变化</div>
              </div>
              <div id="trend-chart" class="w-full h-48 border rounded flex items-center justify-center text-gray-500">暂无数据</div>
            </div>

            <!-- 运价对比（柱状图） -->
            <div id="compare-section" class="bg-white rounded-lg shadow-sm p-6 border border-indigo-500 w-full md:w-1/2">
              <div class="flex items-center justify-between mb-4">
                <h2 id="compare-title" class="text-2xl font-bold h2-gradient">运价对比</h2>
                <div class="text-sm text-gray-600">按船东比较 20GP/40GP/40HQ（航程天数标注）</div>
              </div>
              <div id="compare-chart" class="w-full h-56 border rounded flex items-center justify-center text-gray-500">暂无数据</div>
            </div>
          </div>
        </div>

        <!-- 右侧边栏 - 占1/4宽度 -->
        <div class="w-full md:w-1/4 space-y-6">
          <!-- 地面费用 -->
          <div class="sidebar__card bg-white rounded-lg shadow-sm p-4 border border-green-500">
            <h3 class="sidebar__title text-lg font-bold mb-3 h2-gradient">地面费用</h3>
            <div class="space-y-2 text-sm text-gray-600">
              <p><span class="font-medium">拖车费：</span>提空/重拖运至码头或场站的费用</p>
              <p><span class="font-medium">报关费：</span>出口报关与单证办理费用</p>
              <p><span class="font-medium">仓储费：</span>堆场或仓库短期存储费用</p>
              <p><span class="font-medium">装箱费：</span>散货装箱或拼箱处理费用</p>
              <p><span class="font-medium">港杂费：</span>码头系统费、设备使用费等</p>
              <p><span class="font-medium">加班费：</span>夜间或节假日作业附加费用</p>
            </div>
          </div>

          <!-- 成本核算 -->
          <div class="sidebar__card bg-white rounded-lg shadow-sm p-4 border border-orange-500">
            <h3 class="sidebar__title text-lg font-bold mb-3 h2-gradient">成本核算</h3>
            <div class="space-y-3 text-sm text-gray-700">
              <div>
                <!-- 起运港：与“海运费用查询”一致，改为下拉选择（数据来源相同） -->
                <select id="calc-origin" class="w-full h-10 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
                  <option value="" selected>请选择起运港</option>
                </select>
              </div>
              <div>
                <!-- 目的港：与“海运费用查询”一致，支持模糊匹配与联想菜单（数据来源相同） -->
                <input id="calc-dest" type="text" placeholder="请输入目的港（支持中文/英文/代码模糊匹配）" list="calc-dest-list" class="w-full h-10 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm" />
                <datalist id="calc-dest-list"></datalist>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">箱型（可多选）</label>
                <div class="flex flex-wrap items-center gap-4">
                  <div class="inline-flex items-center gap-2">
                    <label class="inline-flex items-center gap-1 text-gray-700"><input id="type-20gp" type="checkbox" class="accent-primary"><span>20GP</span></label>
                    <div id="qty-20gp-wrap" class="hidden">
                      <input id="qty-20gp" type="number" min="0" value="0" class="w-24 px-2 py-1 border border-gray-300 rounded" placeholder="数量" />
                    </div>
                  </div>
                  <div class="inline-flex items-center gap-2">
                    <label class="inline-flex items-center gap-1 text-gray-700"><input id="type-40gp" type="checkbox" class="accent-primary"><span>40GP</span></label>
                    <div id="qty-40gp-wrap" class="hidden">
                      <input id="qty-40gp" type="number" min="0" value="0" class="w-24 px-2 py-1 border border-gray-300 rounded" placeholder="数量" />
                    </div>
                  </div>
                  <div class="inline-flex items-center gap-2">
                    <label class="inline-flex items-center gap-1 text-gray-700"><input id="type-40hq" type="checkbox" class="accent-primary"><span>40HQ</span></label>
                    <div id="qty-40hq-wrap" class="hidden">
                      <input id="qty-40hq" type="number" min="0" value="0" class="w-24 px-2 py-1 border border-gray-300 rounded" placeholder="数量" />
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">船东</label>
                <select id="calc-carrier" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                  <option value="all">所有船东</option>
                  <option value="msc">地中海航运(MSC)</option>
                  <option value="maersk">马士基(Maersk)</option>
                  <option value="cma">达飞轮船(CMA CGM)</option>
                  <option value="cosco">中远海运(COSCO Shipping)</option>
                  <option value="hapag">赫伯罗特(Hapag-Lloyd)</option>
                  <option value="one">海洋网联(ONE)</option>
                  <option value="evergreen">长荣海运(Evergreen)</option>
                  <option value="hmm">现代商船(HMM)</option>
                  <option value="zim">以星航运(ZIM)</option>
                  <option value="yangming">阳明海运(Yang Ming)</option>
                  <option value="oocl">东方海外(OOCL)</option>
                  <option value="pil">太平船务(PIL)</option>
                  <option value="wanhai">万海航运(Wan Hai)</option>
                  <option value="kmtc">高丽海运(KMTC)</option>
                  <option value="sitc">海丰国际(SITC)</option>
                  <option value="tslines">德翔海运(TS Lines)</option>
                  <option value="rcl">宏海船务(RCL)</option>
                  <option value="smline">长锦商船(SM Line)</option>
                  <option value="ckline">天敬海运(CK Line)</option>
                  <option value="namsung">南星船务(NAMSUNG)</option>
                </select>
              </div>
              
              <button id="calc-btn" class="btn-primary w-full h-10 flex items-center justify-center">
                <i class="fas fa-calculator mr-2"></i>
                <span>计算</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 页脚容器 -->
  <div id="footer-container"></div>

  <script>
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 加载全局组件
      loadComponent('header-container', '/components/header.html');
      loadComponent('footer-container', '/components/footer.html');
      
      // 初始化查询功能
      initPricingFunction();

      // 初始化成本核算交互
      initCostCalculation();

      // 初始化批量报价弹窗与按钮事件
      ensureBatchQuoteModal();
      const batchBtn = document.getElementById('batch-quote-btn');
      if (batchBtn) {
        batchBtn.addEventListener('click', function(){
          if (!Array.isArray(filteredQuotes) || filteredQuotes.length === 0){
            alert('请先查询出运价结果');
            return;
          }
          showBatchQuoteModal();
        });
      }
    });

    // 本地演示：运费报价数据源
    const QUOTES_KEY = 'freight_quotes_db';

    function seedQuotesIfEmpty() {
      try {
        const existing = JSON.parse(localStorage.getItem(QUOTES_KEY) || '[]');
        if (existing && existing.length > 0) {
          // 如果已有数据，执行一次迁移以补齐新字段
          try { migrateQuotesToNewSchema(); } catch {}
          return;
        }
      } catch {}
      const sample = [
        { origin: '上海', destination: '洛杉矶', rate20gp: 900, rate40gp: 1500, rate40hq: 1560, carrier: 'MSC', sailing: '2025-11-15', duration: '14天', serviceType: '直航', remark: '限时优惠' },
        { origin: '宁波', destination: '纽约', rate20gp: 950, rate40gp: 1600, rate40hq: 1665, carrier: 'MAERSK', sailing: '2025-11-16', duration: '18天', serviceType: '中转', remark: '经巴拿马' },
        { origin: '青岛', destination: '汉堡', rate20gp: 800, rate40gp: 1400, rate40hq: 1470, carrier: 'CMA CGM', sailing: '2025-11-18', duration: '28天', serviceType: '直航', remark: '旺季附加费' },
        { origin: '深圳', destination: '长滩', rate20gp: 880, rate40gp: 1450, rate40hq: 1510, carrier: 'COSCO', sailing: '2025-11-17', duration: '12天', serviceType: '直航', remark: '快船服务' },
        { origin: '厦门', destination: '西雅图', rate20gp: 860, rate40gp: 1420, rate40hq: 1480, carrier: 'HAPAG-LLOYD', sailing: '2025-11-19', duration: '16天', serviceType: '中转', remark: '' },
        { origin: '上海', destination: '温哥华', rate20gp: 820, rate40gp: 1380, rate40hq: 1440, carrier: 'ONE', sailing: '2025-11-20', duration: '13天', serviceType: '直航', remark: '加班船' },
        { origin: '天津', destination: '费利克斯托', rate20gp: 780, rate40gp: 1320, rate40hq: 1380, carrier: 'EVERGREEN', sailing: '2025-11-22', duration: '30天', serviceType: '中转', remark: '' },
        { origin: '广州', destination: '洛杉矶', rate20gp: 910, rate40gp: 1520, rate40hq: 1580, carrier: 'HMM', sailing: '2025-11-21', duration: '15天', serviceType: '直航', remark: '旺季紧张' },
        { origin: '大连', destination: '鹿特丹', rate20gp: 770, rate40gp: 1290, rate40hq: 1350, carrier: 'ZIM', sailing: '2025-11-23', duration: '29天', serviceType: '中转', remark: '' },
        { origin: '宁波', destination: '洛杉矶', rate20gp: 905, rate40gp: 1495, rate40hq: 1555, carrier: 'MSC', sailing: '2025-11-24', duration: '14天', serviceType: '直航', remark: '直航' },
      ];
      localStorage.setItem(QUOTES_KEY, JSON.stringify(sample));
    }

    // 读取所有报价
    function getAllQuotes() {
      try { return JSON.parse(localStorage.getItem(QUOTES_KEY) || '[]'); } catch { return []; }
    }

    // 渲染表格（分页）
    let currentPage = 1;
    const PAGE_SIZE = 20;
    let filteredQuotes = [];

    // 端口库辅助：起运港/目的港列表与模糊匹配
    const originPortsKey = 'origin_ports_db';
    const destPortsKey = 'destination_ports_db';
    function getOriginPorts(){ try { return JSON.parse(localStorage.getItem(originPortsKey)||'[]'); } catch { return []; } }
    function getDestPorts(){ try { return JSON.parse(localStorage.getItem(destPortsKey)||'[]'); } catch { return []; } }
    function normalizeName(s){
      if (!s) return '';
      const t = s.toString().trim();
      const isAscii = /^[\x00-\x7F]*$/.test(t);
      if (isAscii){
        return t.toLowerCase().replace(/[\s\-_.()\[\]{}'"·・/\\]/g,'');
      }
      return t; // 中文直接用原文匹配
    }
    function getOriginPortsFallbackIfEmpty(){
      const list = getOriginPorts();
      if (Array.isArray(list) && list.length>0) return list;
      // Fallback：从报价中收集唯一起运港（仅中文名）
      const names = new Set((getAllQuotes()||[]).map(q=>q.origin).filter(Boolean));
      return Array.from(names).map(cn=>({cn, en:'', code:'', aliases:[]}));
    }
    function getDestPortsFallbackIfEmpty(){
      const list = getDestPorts();
      if (Array.isArray(list) && list.length>0) return list;
      // Fallback：从报价中收集唯一目的港（仅中文名）
      const names = new Set((getAllQuotes()||[]).map(q=>q.destination).filter(Boolean));
      return Array.from(names).map(cn=>({cn, en:'', code:'', aliases:[]}));
    }
    function fuzzyFilterPorts(query, list, limit=20){
      // 只匹配“前缀”，即首字顺序：h->以h开头；hu->以hu开头；“汉”->以“汉”开头
      const q = normalizeName(query);
      const isAscii = /^[\x00-\x7F]*$/.test(query||'');
      const out = [];
      for (const p of (list||[])){
        const cn = p.cn||''; const en = p.en||''; const code = (p.code||'').toLowerCase();
        const cnKey = normalizeName(cn); const enKey = normalizeName(en);
        if (!q){ out.push(p); }
        else if (isAscii){
          if ((enKey && enKey.startsWith(q)) || (code && code.startsWith(q))) out.push(p);
        } else {
          if (cnKey && cnKey.startsWith(q)) out.push(p);
        }
        if (out.length>=limit) break;
      }
      return out;
    }
    function findPortFromQuery(query, list){
      if (!query) return null;
      const q = normalizeName(query);
      const isAscii = /^[\x00-\x7F]*$/.test(query||'');
      for (const p of (list||[])){
        const cn = p.cn||''; const en = p.en||''; const code = (p.code||'').toLowerCase();
        const cnKey = normalizeName(cn); const enKey = normalizeName(en);
        if (isAscii){
          if ((enKey && enKey.startsWith(q)) || (code && code.startsWith(q))) return p;
        } else {
          if (cnKey && cnKey.startsWith(q)) return p;
        }
      }
      return null;
    }
    function populateOriginSelect(selectId = 'pricing-origin'){
      const sel = document.getElementById(selectId); if (!sel) return;
      // 保留“请选择起运港”
      sel.innerHTML = '<option value="" selected>请选择起运港</option>';
      const list = getOriginPortsFallbackIfEmpty();
      const used = new Set();
      (list||[]).forEach(p=>{
        const name = (p.cn||'').trim(); if (!name || used.has(name)) return; used.add(name);
        const text = `${p.cn||''}${p.code?` (${p.code})`:''}${p.en?` / ${p.en}`:''}`;
        const opt = document.createElement('option'); opt.value = p.cn||''; opt.textContent = text;
        sel.appendChild(opt);
      });
      // 应用 URL 预填
      const pf = window.__pricing_prefill || {}; if (pf.origin){
        // 优先按中文名匹配，否则尝试按 code
        const wanted = pf.originCode ? `${pf.origin} (${pf.originCode})` : pf.origin;
        // 尝试直接设值为中文名
        sel.value = pf.origin;
        if (!sel.value){
          // 尝试按 code 匹配找到对应中文名
          const match = (list||[]).find(p => (p.code||'').toUpperCase() === (pf.originCode||'').toUpperCase() || (p.cn||'') === pf.origin);
          if (match) sel.value = match.cn||'';
        }
      }
    }
    function initDestDatalist(inputId = 'pricing-dest', listId = 'pricing-dest-list'){
      const input = document.getElementById(inputId); const dl = document.getElementById(listId);
      if (!input || !dl) return;
      const list = getDestPortsFallbackIfEmpty();
      function render(q){
        const matches = fuzzyFilterPorts(q, list, 30);
        dl.innerHTML = '';
        matches.forEach(p=>{
          const isAscii = /^[\x00-\x7F]*$/.test(q||'');
          const val = isAscii ? (p.en||p.cn||'') : (p.cn||p.en||'');
          const opt = document.createElement('option'); opt.value = val; opt.label = `${p.cn||''}${p.en?` / ${p.en}`:''}${p.code?` (${p.code})`:''}`;
          dl.appendChild(opt);
        });
      }
      input.addEventListener('input', function(){ render(input.value||''); });
      // 初始渲染（空查询展示前若干）
      render('');
      // 应用 URL 预填
      const pf = window.__pricing_prefill || {}; if (pf.destination){ input.value = pf.destCode ? `${pf.destination} (${pf.destCode})` : pf.destination; }
    }
    // 从项目TXT加载 起运港/目的港：/数据/起运港.txt /数据/目的港.txt
    function parseOriginTXT(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = [];
      lines.forEach(line => {
        const parts = line.split(/\s*-\s*/);
        const left = (parts[0]||'').trim();
        const right = (parts[1]||'').trim();
        const lp = left.split('・');
        const ep = right.split('・');
        const en = (lp[0]||'').trim();
        const cnRaw = (ep[0]||'').trim();
        const cn = cnRaw.split('/')[0].trim(); // 去掉“中文 / 国家”中的国家部分
        if (!cn && !en) return;
        items.push({ cn, en, code:'', aliases:[] });
      });
      return items;
    }
    function parseDestTXT(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = [];
      lines.forEach(line => {
        const parts = line.split(/\s*-\s*/);
        const left = (parts[0]||'').trim();
        const right = (parts[1]||'').trim();
        const lp = left.split('・');
        const ep = right.split('・');
        const en = (lp[0]||'').trim();
        const cnRaw = (ep[0]||'').trim();
        const cn = cnRaw.split('/')[0].trim(); // 去掉“中文 / 国家”中的国家部分
        if (!cn && !en) return;
        items.push({ cn, en, code:'', aliases:[] });
      });
      return items;
    }
    async function loadOriginPortsFromTXTIfEmpty(){
      try {
        const curr = getOriginPorts(); if (Array.isArray(curr) && curr.length>0) return curr;
        const path = '/数据/起运港.txt';
        const url = encodeURI(path);
        const res = await fetch(url);
        if (!res.ok) throw new Error('无法加载起运港TXT');
        const text = await res.text();
        const items = parseOriginTXT(text);
        if (Array.isArray(items) && items.length>0){ localStorage.setItem(originPortsKey, JSON.stringify(items)); return items; }
      } catch(e){ console.warn('loadOriginPortsFromTXTIfEmpty error', e); }
      return getOriginPortsFallbackIfEmpty();
    }
    async function loadDestPortsFromTXTIfEmpty(){
      try {
        const curr = getDestPorts(); if (Array.isArray(curr) && curr.length>0) return curr;
        const path = '/数据/目的港.txt';
        const url = encodeURI(path);
        const res = await fetch(url);
        if (!res.ok) throw new Error('无法加载目的港TXT');
        const text = await res.text();
        const items = parseDestTXT(text);
        if (Array.isArray(items) && items.length>0){ localStorage.setItem(destPortsKey, JSON.stringify(items)); return items; }
      } catch(e){ console.warn('loadDestPortsFromTXTIfEmpty error', e); }
      return getDestPortsFallbackIfEmpty();
    }
    async function initPortInputs(){
      // 先尝试从TXT填充本地库，然后渲染控件
      await Promise.all([loadOriginPortsFromTXTIfEmpty(), loadDestPortsFromTXTIfEmpty()]);
      // 前台查询区域
      populateOriginSelect('pricing-origin');
      initDestDatalist('pricing-dest','pricing-dest-list');
      // 成本核算区域（与查询区域一致，数据来源相同）
      populateOriginSelect('calc-origin');
      initDestDatalist('calc-dest','calc-dest-list');
    }

    // 船公司标准名称映射（来自 data/masters/shipping_lines_sample.csv）
    let shippingLinesMap = null; // { key -> { cn, en, code } }
    function parseCSVLines(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
      // 跳过表头
      const body = lines.slice(1);
      return body.map(l=>{
        const parts = l.split(',');
        const [cn,en,code] = [parts[0]||'', parts[1]||'', parts[2]||''];
        return { cn: cn.trim(), en: en.trim(), code: code.trim() };
      });
    }
    async function loadShippingLinesMaster(){
      if (shippingLinesMap) return shippingLinesMap;
      const map = {};
      try {
        const res = await fetch('/data/masters/shipping_lines_sample.csv');
        if (!res.ok) throw new Error('无法加载船东列表CSV');
        const text = await res.text();
        const items = parseCSVLines(text);
        items.forEach(({cn,en,code})=>{
          const keys = [cn,en,code].filter(Boolean);
          keys.forEach(k=>{ map[k.toUpperCase()] = { cn, en, code }; });
          // 常见别名/变体键（不再使用错误的 toUpperCase 判断）
          const EN = (en||'').toUpperCase();
          if (EN==='CMA CGM') map['CMA'] = { cn,en,code };
          if (EN==='MAERSK') map['MSK'] = { cn,en,code };
          if (EN==='HAPAG-LLOYD') map['HPL'] = { cn,en,code };
          if (EN==='ONE') { map['OCEAN NETWORK EXPRESS'] = { cn,en,code }; map['ONE LINE'] = { cn,en,code }; }
          if (EN==='COSCO') { map['COSCO SHIPPING'] = { cn,en,code }; map['COSCO SHIPPING LINES'] = { cn,en,code }; }
        });
      } catch(e){
        console.warn('加载船东列表失败，使用内置映射', e);
        [
          { cn:'地中海航运', en:'MSC', code:'MSC' },
          { cn:'马士基', en:'MAERSK', code:'MSK' },
          { cn:'达飞轮船', en:'CMA CGM', code:'CMA' },
          { cn:'中远海运', en:'COSCO', code:'COSCO' },
          { cn:'赫伯罗特', en:'Hapag-Lloyd', code:'HPL' },
          { cn:'海洋联盟', en:'ONE', code:'ONE' },
        ].forEach(({cn,en,code})=>{
          [cn,en,code].forEach(k=>{ map[k.toUpperCase()] = { cn,en,code }; });
        });
      }
      shippingLinesMap = map;
      return map;
    }
    function getStandardCarrierDisplay(raw){
      const s = (raw||'').toString().trim(); if (!s) return '-';
      const key = s.toUpperCase();
      const m = shippingLinesMap && shippingLinesMap[key];
      if (m) return m.en; // 统一用英文名显示
      // 进一步尝试：去除多余空格后匹配、子串包含匹配
      const k2 = key.replace(/\s+/g,' ');
      const map = shippingLinesMap || {};
      const hit = Object.keys(map).find(k=>k===k2 || k2.includes(k));
      if (hit) return map[hit].en;
      // 常见缩写容错
      const alias = {
        'MAERSK':'MAERSK','MSK':'MAERSK',
        'CMA':'CMA CGM','CMA CGM':'CMA CGM',
        'MSC':'MSC',
        'COSCO':'COSCO','COSCO SHIPPING':'COSCO',
        'HAPAG-LLOYD':'Hapag-Lloyd','HPL':'Hapag-Lloyd',
        'ONE':'ONE','OCEAN NETWORK EXPRESS':'ONE'
      };
      if (alias[key]) return alias[key];
      return s; // 无法标准化时原样返回
    }
    function getStandardCarrierCode(raw){
      const s = (raw||'').toString().trim(); if (!s) return '-';
      const key = s.toUpperCase();
      const m = shippingLinesMap && shippingLinesMap[key];
      if (m && m.code) return m.code; // 返回代码
      // 进一步尝试：去除多余空格后匹配、子串包含匹配
      const k2 = key.replace(/\s+/g,' ');
      const map = shippingLinesMap || {};
      const hit = Object.keys(map).find(k=>k===k2 || k2.includes(k));
      if (hit && map[hit] && map[hit].code) return map[hit].code;
      // 常见缩写容错 -> 直接映射到代码
      const alias = {
        'MAERSK':'MSK','MSK':'MSK',
        'CMA':'CMA','CMA CGM':'CMA',
        'MSC':'MSC',
        'COSCO':'COSCO','COSCO SHIPPING':'COSCO','COSCO SHIPPING LINES':'COSCO',
        'HAPAG-LLOYD':'HPL','HPL':'HPL',
        'ONE':'ONE','OCEAN NETWORK EXPRESS':'ONE','ONE LINE':'ONE'
      };
      if (alias[key]) return alias[key];
      return s; // 无法标准化时原样返回
    }

    // 解析人民币费用TXT并按“按箱/按票，区分 20GP/40GP/HQ”构建HTML表
    async function __buildRmbTableFromTXT(firstCarrier, showMultiNote = false){
      function splitFlexible(line){
        if (line.includes('\t')) return line.split('\t').map(s=>s.trim());
        return line.trim().split(/\s+/);
      }
      try {
        const url = encodeURI('/数据/人民币费用.txt');
        const res = await fetch(url);
        if (!res.ok) return '';
        const text = await res.text();
        const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
        let headerIdx = lines.findIndex(l=> l.trim().startsWith('船东'));
        if (headerIdx === -1) return '';
        const headerParts = splitFlexible(lines[headerIdx]);
        const headers = headerParts.slice(1);
        const rows = [];
        for (let i = headerIdx + 1; i < lines.length; i++){
          const raw = lines[i];
          const parts = splitFlexible(raw);
          if (!parts.length) continue;
          const first = parts[0];
          if (first === '人民币费用' || first === '编号' || first === '船东') continue;
          const name = parts[0] || '';
          const spec = parts[1] || '';
          const vals = parts.slice(2);
          const values = Array.from({length: headers.length}, (_,k)=>{
            const v = (vals[k]||'').trim();
            const num = Number(v.replace(/,/g,''));
            return Number.isFinite(num) ? num : null;
          });
          rows.push({ name, spec, values });
        }
        const alias = {
          'MSC':'MSC','MAERSK':'MSK','MSK':'MSK','CMA CGM':'CMA','CMA':'CMA','COSCO':'COSCO','HAPAG-LLOYD':'HPL','HPL':'HPL','ONE':'ONE',
          'EVERGREEN':'EMC','EMC':'EMC','HMM':'HMM','ZIM':'ZIM','YANG MING':'YML','YML':'YML','OOCL':'OOCL','PIL':'PIL',
          'WAN HAI':'万海','WHL':'万海','KMTC':'KMTC','TS LINES':'TSL','TSL':'TSL','RCL':'RCL','SITC':'海丰','海丰':'海丰',
          'CHANGJIN':'长锦','CJ':'长锦','CK':'CK','NANXING':'南星','南星':'南星'
        };
        const upper = (firstCarrier||'').toString().trim().toUpperCase();
        let carrierToken = alias[upper] || firstCarrier || '';
        if (!headers.includes(carrierToken)){
          const m = shippingLinesMap && shippingLinesMap[upper];
          const code = m && (m.code || '').toUpperCase();
          const codeAlias = alias[code] || code;
          if (headers.includes(codeAlias)) carrierToken = codeAlias;
        }
        if (!headers.includes(carrierToken)){
          const hit = headers.find(h=> h.toUpperCase() === upper || upper.includes(h.toUpperCase()) || h.toUpperCase().includes(upper));
          carrierToken = hit || headers[0] || '';
        }
        const idx = headers.indexOf(carrierToken);
        if (idx < 0) return '';
        const knownBillNames = new Set(['预配舱单','文件','电放','SWB','订舱服务费']);
        // 合并到一张表：费用名称 | 20/40（BILL 项显示单值并在名称后标注（BL））
        const merged = {}; // name -> { a20?:number, a40?:number, bill?:number, isBill?:boolean }
        rows.forEach(r=>{
          const val = r.values[idx];
          if (val === null) return;
          const spec = (r.spec||'').toUpperCase();
          const key = r.name;
          if (!merged[key]) merged[key] = {};
          if (spec === 'BILL' || knownBillNames.has(r.name)) { merged[key].bill = val; merged[key].isBill = true; }
          else if (spec.includes('40') || spec.includes('HC')) { merged[key].a40 = val; }
          else { merged[key].a20 = val; }
        });
        const items = Object.keys(merged).map(name=>{
          const m = merged[name];
          const label = m.isBill ? `${name}（BL）` : name;
          let disp = '';
          if (m.isBill && typeof m.bill === 'number') disp = `${m.bill}`;
          else {
            const v20 = typeof m.a20 === 'number' ? m.a20 : null;
            const v40 = typeof m.a40 === 'number' ? m.a40 : null;
            if (v20!=null && v40!=null) disp = `${v20}/${v40}`;
            else if (v20!=null) disp = `${v20}`;
            else if (v40!=null) disp = `${v40}`;
            else disp = '';
          }
          return { name: label, disp };
        }).filter(it=> it.disp !== '');
        // 每行四组：(费用名称 | 20/40) x 4
        const rowsHtml = [];
        for (let i=0; i<items.length; i+=4){
          const a = items[i];
          const b = items[i+1];
          const c = items[i+2];
          const d = items[i+3];
          rowsHtml.push(`
            <tr>
              <td class=\"px-3 py-2\">${a ? a.name : ''}</td>
              <td class=\"px-3 py-2 text-right\">${a ? a.disp : ''}</td>
              <td class=\"px-3 py-2\" style=\"border-left: 1px dashed #e5e7eb;\">${b ? b.name : ''}</td>
              <td class=\"px-3 py-2 text-right\" style=\"border-left: 1px dashed #e5e7eb;\">${b ? b.disp : ''}</td>
              <td class=\"px-3 py-2\" style=\"border-left: 1px dashed #e5e7eb;\">${c ? c.name : ''}</td>
              <td class=\"px-3 py-2 text-right\" style=\"border-left: 1px dashed #e5e7eb;\">${c ? c.disp : ''}</td>
              <td class=\"px-3 py-2\" style=\"border-left: 1px dashed #e5e7eb;\">${d ? d.name : ''}</td>
              <td class=\"px-3 py-2 text-right\" style=\"border-left: 1px dashed #e5e7eb;\">${d ? d.disp : ''}</td>
            </tr>
          `);
        }
        // 计算合计（含BL：BL总额同时计入20与40合计）
        let total20 = 0, total40 = 0, blTotal = 0;
        Object.keys(merged).forEach(k=>{
          const m = merged[k];
          if (m.isBill){
            if (typeof m.bill === 'number') blTotal += m.bill;
          } else {
            if (typeof m.a20 === 'number') total20 += m.a20;
            if (typeof m.a40 === 'number') total40 += m.a40;
          }
        });
        return `
          <div class=\"mt-4\">\n            <div class=\"text-sm font-semibold mb-2\">人民币（地面）费用（船东：${carrierToken||firstCarrier||'未识别'}，示例）</div>\n            <table class=\"w-full text-sm border\">\n              <thead class=\"bg-gray-50\">\n                <tr>\n                  <th class=\"px-3 py-2 text-left\">费用名称</th>\n                  <th class=\"px-3 py-2 text-right\">20/40</th>\n                  <th class=\"px-3 py-2 text-left\" style=\"border-left: 1px dashed #e5e7eb;\">费用名称</th>\n                  <th class=\"px-3 py-2 text-right\" style=\"border-left: 1px dashed #e5e7eb;\">20/40</th>\n                  <th class=\"px-3 py-2 text-left\" style=\"border-left: 1px dashed #e5e7eb;\">费用名称</th>\n                  <th class=\"px-3 py-2 text-right\" style=\"border-left: 1px dashed #e5e7eb;\">20/40</th>\n                  <th class=\"px-3 py-2 text-left\" style=\"border-left: 1px dashed #e5e7eb;\">费用名称</th>\n                  <th class=\"px-3 py-2 text-right\" style=\"border-left: 1px dashed #e5e7eb;\">20/40</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${rowsHtml.join('')}\n              </tbody>\n            </table>\n            <div class=\"mt-2 text-sm\">合计人民币：${(total20 + blTotal)}/${(total40 + blTotal)} <span class=\"text-xs text-gray-500\">（20/40合计均含BL）</span></div>\n            <div class=\"mt-1 text-xs text-gray-700\">备注：以上人民币报价仅供参考，不同的货物，装箱费用会有出入，请和销售确认。</div>\n            ${showMultiNote ? ('<div class=\\\"mt-1 text-xs text-gray-500\\\">当报价表涉及的船东较多时，仅以第一个船东（' + (carrierToken||firstCarrier||'') + '）的人民币收费为示例，其他船东的人民币收费请联系销售。</div>') : ''}\n          </div>
        `;
      } catch(e){ console.warn('TXT人民币费用构建失败', e); return ''; }
    }

    function renderQuotes(quotes, page = 1) {
      const tbody = document.getElementById('quotes-tbody');
      const countEl = document.getElementById('quotes-count');
      const pageInfo = document.getElementById('page-info');
      if (!tbody) return;
      // 确保已加载船东标准映射
      loadShippingLinesMaster().catch(()=>{});
      const total = quotes.length;
      if (countEl) countEl.textContent = `共 ${total} 条记录，每页 ${PAGE_SIZE} 条`;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      currentPage = Math.min(Math.max(1, page), totalPages);
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageData = quotes.slice(start, start + PAGE_SIZE);
      tbody.innerHTML = '';
      pageData.forEach((q, idx) => {
        const tr = document.createElement('tr');
        const carrierCode = getStandardCarrierCode(q.carrier);
        tr.innerHTML = `
          <td class="py-2 px-4 border-b">${start + idx + 1}</td>
          <td class="py-2 px-4 border-b">${q.origin}</td>
          <td class="py-2 px-4 border-b">${q.destination}</td>
          <td class="py-2 px-4 border-b">${q.rate20gp ?? '-'}</td>
          <td class="py-2 px-4 border-b">${(q.rate40gp ?? '-')}${(q.rate40hq!==undefined)?` / ${q.rate40hq}`:''}</td>
          <td class="py-2 px-4 border-b">${carrierCode ?? '-'}</td>
          <td class="py-2 px-4 border-b">${q.sailing ?? '-'}</td>
          <td class="py-2 px-4 border-b">${q.duration ?? '-'}</td>
          <td class="py-2 px-4 border-b">${q.serviceType ?? '-'}</td>
          <td class="py-2 px-4 border-b">${q.remark ?? ''}</td>
        `;
        tbody.appendChild(tr);
      });
      if (pageInfo) pageInfo.textContent = `第 ${currentPage} / ${totalPages} 页`;
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    }

    function applyFilter() {
      const origin = (document.getElementById('pricing-origin')?.value || '').trim();
      const destRaw = (document.getElementById('pricing-dest')?.value || '').trim();
      const all = getAllQuotes();
      // 目的港模糊识别（中文/英文/UN/LOCODE）
      const destList = getDestPortsFallbackIfEmpty();
      const destRec = findPortFromQuery(destRaw, destList);
      filteredQuotes = all.filter(q => {
        const matchOrigin = origin ? ((q.origin || '').includes(origin)) : true;
        let matchDest = true;
        if (destRaw) {
          const qd = (q.destination || '').toString();
          if (destRec) {
            // 仅按“前缀”匹配目的港
            matchDest = (
              (destRec.cn && qd.startsWith(destRec.cn)) ||
              (destRec.en && qd.toLowerCase().startsWith((destRec.en||'').toLowerCase())) ||
              (destRec.code && qd.toUpperCase().startsWith((destRec.code||'').toUpperCase()))
            );
          } else {
            // 未识别到列表项时，直接对输入做前缀匹配（注意：中文/英文不跨语种匹配）
            matchDest = qd.startsWith(destRaw);
          }
        }
        return matchOrigin && matchDest;
      });
      renderQuotes(filteredQuotes, 1);
      // 更新批量报价按钮状态 & 渲染图表
      updateBatchQuoteBtn();
      renderTrendAndCompare();
    }

    // 初始化费用查询功能（新版：筛选表格）
    function initPricingFunction() {
      seedQuotesIfEmpty();
      // 初始化端口控件（下拉与联想）
      initPortInputs();
      const all = getAllQuotes();
      filteredQuotes = all;
      renderQuotes(filteredQuotes, 1);
      updateBatchQuoteBtn();
      renderTrendAndCompare();
      const searchBtn = document.getElementById('pricing-search-btn');
      if (searchBtn) {
        searchBtn.addEventListener('click', function() {
          applyFilter();
        });
      }
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      if (prevBtn) prevBtn.addEventListener('click', function(){ renderQuotes(filteredQuotes, currentPage - 1); });
      if (nextBtn) nextBtn.addEventListener('click', function(){ renderQuotes(filteredQuotes, currentPage + 1); });
    }

    // 成本核算：简易匹配与合计弹窗
    function initCostCalculation(){
      // 复选控制数量输入显隐
      const boxPairs = [
        { type: 'type-20gp', wrap: 'qty-20gp-wrap', input: 'qty-20gp' },
        { type: 'type-40gp', wrap: 'qty-40gp-wrap', input: 'qty-40gp' },
        { type: 'type-40hq', wrap: 'qty-40hq-wrap', input: 'qty-40hq' },
      ];
      boxPairs.forEach(({type, wrap, input})=>{
        const typeEl = document.getElementById(type);
        const wrapEl = document.getElementById(wrap);
        const inputEl = document.getElementById(input);
        if (typeEl && wrapEl && inputEl) {
          typeEl.addEventListener('change', ()=>{
            if (typeEl.checked){
              wrapEl.classList.remove('hidden');
              if (parseInt(inputEl.value||'0',10) === 0) inputEl.value = 1;
            } else {
              wrapEl.classList.add('hidden');
              inputEl.value = 0;
            }
          });
        }
      });

      const calcBtn = document.getElementById('calc-btn');
      if (calcBtn) {
        calcBtn.addEventListener('click', ()=>{
          showQuoteModal();
        });
      }
    }

    function computeTotal(){
      const origin = (document.getElementById('calc-origin')?.value || '').trim();
      const dest = (document.getElementById('calc-dest')?.value || '').trim();
      const carrier = (document.getElementById('calc-carrier')?.value || '').trim();
      const qty20 = parseInt(document.getElementById('qty-20gp')?.value || '0', 10) || 0;
      const qty40 = parseInt(document.getElementById('qty-40gp')?.value || '0', 10) || 0;
      const qty40hq = parseInt(document.getElementById('qty-40hq')?.value || '0', 10) || 0;
      // 按箱型与箱量计算（前台不再读取日期与地面费用，改由后台处理）

      const all = getAllQuotes();
      // 简易匹配：按起运港/目的港过滤，船东暂不参与匹配（演示版）
      const matched = all.filter(q => {
        const matchOrigin = origin ? (q.origin || '').includes(origin) : true;
        const matchDest = dest ? (q.destination || '').includes(dest) : true;
        return matchOrigin && matchDest;
      });
      // 选用第一条或默认0
      const base = matched[0] || { rate20gp: 0, rate40gp: 0, rate40hq: 0 };
      const rate20 = Number(base.rate20gp || 0);
      const rate40gp = Number(base.rate40gp || 0);
      const rate40hq = Number((base.rate40hq ?? base.rate40gp) || 0);
      // 预计时间优先取运价数据（若有），否则留空，由上层决定回填/展示
      const cutoff = base.cutoff || null;
      const etd = base.etd || null;
      const eta = base.eta || null;
      // 40HQ 优先使用 rate40hq，否则回退到 rate40gp
      const freightTotal = qty20*rate20 + qty40*rate40gp + qty40hq*rate40hq;
      const total = freightTotal; // 与人民币地面费用分开统计
      return {
        origin, dest, carrier,
        qty20, qty40, qty40hq,
        rate20, rate40gp, rate40hq,
        freightTotal,
        total,
        cutoff, etd, eta,
        matchedCount: matched.length
      };
    }

// 报价编辑模式（仅 Pro 及以上会员可用）
let quoteEditMode = false;

async function showQuoteModal(){
      const data = computeTotal();
      ensureQuoteModal();
      const modal = document.getElementById('quote-modal');
      const overlay = document.getElementById('quote-modal-overlay');
      const body = document.getElementById('quote-modal-body');
      const pageInfo = document.getElementById('quote-modal-summary');
      if (!modal || !overlay || !body || !pageInfo) return;

      // 动态信息准备：品牌、销售、自动报价编号、日期、时间、费用
      const companyName = (localStorage.getItem('member_company_name') || '').trim() || '公司名称（可修改）';
      const logoUrl = (localStorage.getItem('member_company_logo') || '').trim() || '/assets/images/logo.webp';
      const now = new Date();
      const todayStr = now.toLocaleDateString('zh-CN');
      const yyyymmdd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
      const salesInfo = (localStorage.getItem('sales_contact') || '').trim() || '张三 / 138-0000-0000';
      // 自动生成报价编号：前缀-日期-序号（每天递增）
      const prefix = (localStorage.getItem('quote_prefix') || '').trim() || 'YX';
      const seqKey = `quote_seq_${yyyymmdd}`;
      const currentSeq = parseInt(localStorage.getItem(seqKey) || '0', 10) || 0;
      const nextSeq = currentSeq + 1;
      localStorage.setItem(seqKey, String(nextSeq));
      const quoteNo = `${prefix}-${yyyymmdd}-${String(nextSeq).padStart(3,'0')}`;
      // 预计时间：优先使用匹配到的运价数据，否则回退到本地存储或示例值
      const cutoff = data.cutoff || (localStorage.getItem('estimate_cutoff') || '').trim() || '2025-01-05';
      const etd = data.etd || (localStorage.getItem('estimate_etd') || '').trim() || '2025-01-08';
      const eta = data.eta || (localStorage.getItem('estimate_eta') || '').trim() || '2025-02-01';
      const fees = {
        thc: Number(localStorage.getItem('fees_thc') || 0),
        port: Number(localStorage.getItem('fees_port') || 0),
        seal: Number(localStorage.getItem('fees_seal') || 0),
        doc: Number(localStorage.getItem('fees_doc') || 0),
        vgm: Number(localStorage.getItem('fees_vgm') || 0),
        sec: Number(localStorage.getItem('fees_sec') || 0),
        chc: Number(localStorage.getItem('fees_chc') || 0),
        equip: Number(localStorage.getItem('fees_equip') || 0),
        manifest: Number(localStorage.getItem('fees_manifest') || 0),
      };
      const feesTotal = Object.values(fees).reduce((sum, v)=> sum + (Number(v)||0), 0);

      // 明细表格行（只显示数量>0的箱型）
      const rows = [];
      if (data.qty20 > 0) {
        rows.push(`<tr>
          <td class="px-3 py-2">20GP</td>
          <td class="px-3 py-2 text-right">${data.qty20}</td>
          <td class="px-3 py-2 text-right">${(data.rate20||0).toFixed(2)}</td>
          <td class="px-3 py-2 text-right">${(data.qty20*data.rate20).toFixed(2)}</td>
        </tr>`);
      }
      if (data.qty40 > 0) {
        rows.push(`<tr>
          <td class="px-3 py-2">40GP</td>
          <td class="px-3 py-2 text-right">${data.qty40}</td>
          <td class="px-3 py-2 text-right">${(data.rate40gp||0).toFixed(2)}</td>
          <td class="px-3 py-2 text-right">${(data.qty40*data.rate40gp).toFixed(2)}</td>
        </tr>`);
      }
      if (data.qty40hq > 0) {
        rows.push(`<tr>
          <td class="px-3 py-2">40HQ</td>
          <td class="px-3 py-2 text-right">${data.qty40hq}</td>
          <td class="px-3 py-2 text-right">${(data.rate40hq||data.rate40gp||0).toFixed(2)}</td>
          <td class="px-3 py-2 text-right">${(data.qty40hq*(data.rate40hq||data.rate40gp||0)).toFixed(2)}</td>
        </tr>`);
      }

      function renderQuoteBody(editing){
        const usdRowsDisplay = [];
        if (data.qty20 > 0) {
          usdRowsDisplay.push(`<tr>
            <td class="px-3 py-2">20GP</td>
            <td class="px-3 py-2 text-right">${data.qty20}</td>
            <td class="px-3 py-2 text-right">${(data.rate20||0).toFixed(2)}</td>
            <td class="px-3 py-2 text-right">${(data.qty20*data.rate20).toFixed(2)}</td>
          </tr>`);
        }
        if (data.qty40 > 0) {
          usdRowsDisplay.push(`<tr>
            <td class="px-3 py-2">40GP</td>
            <td class="px-3 py-2 text-right">${data.qty40}</td>
            <td class="px-3 py-2 text-right">${(data.rate40gp||0).toFixed(2)}</td>
            <td class="px-3 py-2 text-right">${(data.qty40*data.rate40gp).toFixed(2)}</td>
          </tr>`);
        }
        if (data.qty40hq > 0) {
          usdRowsDisplay.push(`<tr>
            <td class="px-3 py-2">40HQ</td>
            <td class="px-3 py-2 text-right">${data.qty40hq}</td>
            <td class="px-3 py-2 text-right">${(data.rate40hq||data.rate40gp||0).toFixed(2)}</td>
            <td class="px-3 py-2 text-right">${(data.qty40hq*(data.rate40hq||data.rate40gp||0)).toFixed(2)}</td>
          </tr>`);
        }

        const usdRowsEdit = [];
        if (data.qty20 > 0) {
          usdRowsEdit.push(`<tr>
            <td class="px-3 py-2">20GP</td>
            <td class="px-3 py-2 text-right">${data.qty20}</td>
            <td class="px-3 py-2 text-right"><input id="rate20Input" type="number" step="0.01" class="w-24 border rounded px-2 py-1 text-right" value="${(data.rate20||0).toFixed(2)}"></td>
            <td class="px-3 py-2 text-right"><span id="sub20">${(data.qty20*data.rate20).toFixed(2)}</span></td>
          </tr>`);
        }
        if (data.qty40 > 0) {
          usdRowsEdit.push(`<tr>
            <td class="px-3 py-2">40GP</td>
            <td class="px-3 py-2 text-right">${data.qty40}</td>
            <td class="px-3 py-2 text-right"><input id="rate40gpInput" type="number" step="0.01" class="w-24 border rounded px-2 py-1 text-right" value="${(data.rate40gp||0).toFixed(2)}"></td>
            <td class="px-3 py-2 text-right"><span id="sub40gp">${(data.qty40*data.rate40gp).toFixed(2)}</span></td>
          </tr>`);
        }
        if (data.qty40hq > 0) {
          usdRowsEdit.push(`<tr>
            <td class="px-3 py-2">40HQ</td>
            <td class="px-3 py-2 text-right">${data.qty40hq}</td>
            <td class="px-3 py-2 text-right"><input id="rate40hqInput" type="number" step="0.01" class="w-24 border rounded px-2 py-1 text-right" value="${((data.rate40hq||data.rate40gp)||0).toFixed(2)}"></td>
            <td class="px-3 py-2 text-right"><span id="sub40hq">${(data.qty40hq*(data.rate40hq||data.rate40gp||0)).toFixed(2)}</span></td>
          </tr>`);
        }

        const usdTable = editing ? usdRowsEdit.join('') : usdRowsDisplay.join('');
        const usdTotalVal = data.total.toFixed(2);

        return `
        <div class="text-sm">
          <!-- 头部：公司 + 标题 同一行；下一行 业务员 / 报价编号 / 日期 同一行 -->
          <div class="border-b border-dashed pb-2">
            <div class="flex items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <img src="${logoUrl}" alt="logo" class="h-6 w-6 object-contain"/>
                <span class="font-bold">${companyName}</span>
              </div>
              <div class="text-base font-bold">运费报价单（线稿）</div>
            </div>
            <div class="mt-2 flex items-center justify-between gap-4 text-xs text-gray-600">
              <div class="flex-1">业务员 ${salesInfo}</div>
              <div class="flex-1 text-center">报价编号：${quoteNo}</div>
              <div class="flex-1 text-right">日期：${todayStr}</div>
            </div>
          </div>

          <!-- 信息栅格：起运港/目的港 与 船东 -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 py-3 border-b border-dashed">
            <div class="flex items-center justify-between"><span class="text-gray-600">起运港 / 目的港</span><span class="font-medium">${data.origin || '-'} / ${data.dest || '-'}</span></div>
            <div class="flex items-center justify-between"><span class="text-gray-600">船东</span><span class="font-medium">${data.carrier || '不限'}</span></div>
            <!-- 预计时间：同一行显示三项 -->
            <div class="sm:col-span-2 flex flex-wrap gap-6 mt-1">
              <div class="flex items-center gap-1"><span class="text-gray-600">预计截单时间：</span><span class="font-medium">${cutoff}</span></div>
              <div class="flex items-center gap-1"><span class="text-gray-600">预计开船日：</span><span class="font-medium">${etd}</span></div>
              <div class="flex items-center gap-1"><span class="text-gray-600">预计到港时间：</span><span class="font-medium">${eta}</span></div>
            </div>
          </div>

          <!-- 美金运费表格 -->
          <div class="mt-3 border border-dashed rounded-md overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left">箱型</th>
                  <th class="px-3 py-2 text-right">数量</th>
                  <th class="px-3 py-2 text-right">单价（USD）</th>
                  <th class="px-3 py-2 text-right">小计（USD）</th>
                </tr>
              </thead>
              <tbody>${(editing ? usdRowsEdit : usdRowsDisplay).join('') || `<tr><td colspan="4" class="px-3 py-4 text-center text-gray-500">未选择箱型或数量为 0</td></tr>`}</tbody>
              <tfoot class="bg-gray-50">
                <tr>
                  <td class="px-3 py-2 text-right font-bold" colspan="3">合计（USD）</td>
                  <td id="usd-total" class="px-3 py-2 text-right font-bold text-primary">${usdTotalVal}</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- 地面费用（人民币）表格（与美金表一致的结构，支持按箱叠加与按票） -->
          <div id="rmb-fees-container"></div>

          <!-- 备注 -->
          <div class="mt-2 text-xs text-gray-500">注：运费市场波动频繁，本报价只作为核算参考，不作为运费结算依据。如需订舱请和销售确认。</div>
        </div>
        `;
      }

      body.innerHTML = renderQuoteBody(quoteEditMode);
      // 异步构建人民币费用表并插入，避免在非 async 函数中使用 await
      (async ()=>{
        try {
          const html = await (async function buildRmbContainerFeesTable(carrier, qty20, qty40, qty40hq){
            try {
              const url = encodeURI('/数据/人民币费用.txt');
              const res = await fetch(url);
              if (!res.ok) throw new Error('无法加载人民币费用TXT');
              const text = await res.text();
              function splitFlexible(line){
                if (line.includes('\t')) return line.split('\t').map(s=>s.trim());
                return line.trim().split(/\s+/);
              }
              const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
              let headerIdx = lines.findIndex(l=> l.trim().startsWith('船东'));
              if (headerIdx === -1) throw new Error('人民币费用表缺少表头');
              const headerParts = splitFlexible(lines[headerIdx]);
              const headers = headerParts.slice(1);
              const rows = [];
              for (let i = headerIdx + 1; i < lines.length; i++){
                const raw = lines[i];
                const parts = splitFlexible(raw);
                if (!parts.length) continue;
                const first = parts[0];
                if (first === '人民币费用' || first === '编号' || first === '船东') continue;
                const name = parts[0] || '';
                const spec = parts[1] || '';
                const vals = parts.slice(2);
                const values = Array.from({length: headers.length}, (_,k)=>{
                  const v = (vals[k]||'').trim();
                  const num = Number(v.replace(/,/g,''));
                  return Number.isFinite(num) ? num : null;
                });
                rows.push({ name, spec, values });
              }
              const alias = {
                'MSC':'MSC','MAERSK':'MSK','MSK':'MSK','CMA CGM':'CMA','CMA':'CMA','COSCO':'COSCO','HAPAG-LLOYD':'HPL','HPL':'HPL','ONE':'ONE',
                'EVERGREEN':'EMC','EMC':'EMC','HMM':'HMM','ZIM':'ZIM','YANG MING':'YML','YML':'YML','OOCL':'OOCL','PIL':'PIL',
                'WAN HAI':'万海','WHL':'万海','KMTC':'KMTC','TS LINES':'TSL','TSL':'TSL','RCL':'RCL','SITC':'海丰','海丰':'海丰',
                'CHANGJIN':'长锦','CJ':'长锦','CK':'CK','NANXING':'南星','南星':'南星'
              };
              const upper = (carrier||'').toString().trim().toUpperCase();
              let carrierToken = alias[upper] || carrier || '';
              if (!headers.includes(carrierToken)){
                const m = shippingLinesMap && shippingLinesMap[upper];
                const code = m && (m.code || '').toUpperCase();
                const codeAlias = alias[code] || code;
                if (headers.includes(codeAlias)) carrierToken = codeAlias;
              }
              if (!headers.includes(carrierToken)){
                const hit = headers.find(h=> h.toUpperCase() === upper || upper.includes(h.toUpperCase()) || h.toUpperCase().includes(upper));
                carrierToken = hit || headers[0] || '';
              }
              const idx = headers.indexOf(carrierToken);
              if (idx < 0) throw new Error('未找到匹配的船东列');
              const knownBillNames = new Set(['预配舱单','文件','电放','SWB','订舱服务费']);
              let unit20Sum = 0, unit40Sum = 0, billSum = 0;
              rows.forEach(r=>{
                const val = r.values[idx];
                if (val === null) return;
                const specU = (r.spec||'').toUpperCase();
                if (specU === 'BILL' || knownBillNames.has(r.name)) { billSum += val; }
                else if (specU.includes('40') || specU.includes('HC')) { unit40Sum += val; }
                else { unit20Sum += val; }
              });
              const c20 = Number(qty20||0);
              const c40All = Number(qty40||0) + Number(qty40hq||0);
              const sub20 = unit20Sum * c20;
              const sub40 = unit40Sum * c40All;
              const total = sub20 + sub40 + billSum;
              const rowsHtml = [];
              if (c20 > 0){
                rowsHtml.push(`<tr>
                  <td class=\"px-3 py-2\">20GP 地面费合计（按箱）</td>
                  <td class=\"px-3 py-2 text-right\">${c20}</td>
                  <td class=\"px-3 py-2 text-right\">${unit20Sum.toFixed(2)}</td>
                  <td class=\"px-3 py-2 text-right\">${sub20.toFixed(2)}</td>
                </tr>`);
              }
              if (c40All > 0){
                rowsHtml.push(`<tr>
                  <td class=\"px-3 py-2\">40GP/HQ 地面费合计（按箱）</td>
                  <td class=\"px-3 py-2 text-right\">${c40All}</td>
                  <td class=\"px-3 py-2 text-right\">${unit40Sum.toFixed(2)}</td>
                  <td class=\"px-3 py-2 text-right\">${sub40.toFixed(2)}</td>
                </tr>`);
              }
              rowsHtml.push(`<tr>
                <td class=\"px-3 py-2\">按票（BL）合计</td>
                <td class=\"px-3 py-2 text-right\">1</td>
                <td class=\"px-3 py-2 text-right\">${billSum.toFixed(2)}</td>
                <td class=\"px-3 py-2 text-right\">${billSum.toFixed(2)}</td>
              </tr>`);
              return `
                <div class=\"mt-3 border border-dashed rounded-md overflow-hidden\">
                  <table class=\"w-full text-sm\">
                    <thead class=\"bg-gray-50\">
                      <tr>
                        <th class=\"px-3 py-2 text-left\">费用类别</th>
                        <th class=\"px-3 py-2 text-right\">数量</th>
                        <th class=\"px-3 py-2 text-right\">单价（RMB）</th>
                        <th class=\"px-3 py-2 text-right\">小计（RMB）</th>
                      </tr>
                    </thead>
                    <tbody>${rowsHtml.join('')}</tbody>
                    <tfoot class=\"bg-gray-50\">
                      <tr>
                        <td class=\"px-3 py-2 text-right font-bold\" colspan=\"3\">合计（RMB）</td>
                        <td class=\"px-3 py-2 text-right font-bold text-primary\">${total.toFixed(2)}</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>`;
            } catch(e){
              console.warn('人民币费用明细计算失败，回退为固定费用栅格显示', e);
              const fees = {
                thc: Number(localStorage.getItem('fees_thc') || 0),
                port: Number(localStorage.getItem('fees_port') || 0),
                seal: Number(localStorage.getItem('fees_seal') || 0),
                doc: Number(localStorage.getItem('fees_doc') || 0),
                vgm: Number(localStorage.getItem('fees_vgm') || 0),
                sec: Number(localStorage.getItem('fees_sec') || 0),
                chc: Number(localStorage.getItem('fees_chc') || 0),
                equip: Number(localStorage.getItem('fees_equip') || 0),
                manifest: Number(localStorage.getItem('fees_manifest') || 0),
              };
              const sum = Object.values(fees).reduce((s,v)=> s + (Number(v)||0), 0);
              return `
                <div class=\"mt-3 border border-dashed rounded-md p-3\">
                  <div class=\"font-bold text-gray-600 mb-2\">地面费用（人民币）</div>
                  <div class=\"grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2\">
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">THC</span><span class=\"font-medium\">${fees.thc.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">港杂</span><span class=\"font-medium\">${fees.port.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">铅封</span><span class=\"font-medium\">${fees.seal.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">文件费</span><span class=\"font-medium\">${fees.doc.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">VGM</span><span class=\"font-medium\">${fees.vgm.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">安保</span><span class=\"font-medium\">${fees.sec.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">CHC</span><span class=\"font-medium\">${fees.chc.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">设备</span><span class=\"font-medium\">${fees.equip.toFixed(2)}</span></div>
                    <div class=\"flex items-center justify-between\"><span class=\"text-gray-600\">舱单</span><span class=\"font-medium\">${fees.manifest.toFixed(2)}</span></div>
                  </div>
                  <div class=\"mt-2 flex items-center justify-end text-sm\">
                    <span class=\"font-bold text-gray-700 mr-2\">合计（RMB）</span>
                    <span class=\"font-bold text-primary\">${sum.toFixed(2)}</span>
                  </div>
                </div>`;
            }
          })(data.carrier, data.qty20, data.qty40, data.qty40hq);
          const cont = document.getElementById('rmb-fees-container');
          if (cont) cont.innerHTML = html;
        } catch(e){ console.warn('构建人民币费用表失败', e); }
      })();
      pageInfo.textContent = data.matchedCount ? `匹配到 ${data.matchedCount} 条运价，已按第一条计算（演示版）` : '未匹配到运价，按 0 计算（演示版）';

      // 根据会员等级显示/隐藏“修改报价”按钮（仅 Pro 及以上）
      const editBtn = document.getElementById('quote-modal-edit');
      const isPaid = !!JSON.parse(localStorage.getItem('is_paid_member') || 'false');
      if (editBtn) {
        editBtn.style.display = isPaid ? 'inline-flex' : 'none';
        editBtn.onclick = () => {
          quoteEditMode = !quoteEditMode;
          body.innerHTML = renderQuoteBody(quoteEditMode);
          // 重新填充人民币费用表
          (async ()=>{
            try {
              const html = await (async function buildRmbContainerFeesTable(carrier, qty20, qty40, qty40hq){
                try {
                  const url = encodeURI('/数据/人民币费用.txt');
                  const res = await fetch(url);
                  if (!res.ok) throw new Error('无法加载人民币费用TXT');
                  const text = await res.text();
                  function splitFlexible(line){
                    if (line.includes('\t')) return line.split('\t').map(s=>s.trim());
                    return line.trim().split(/\s+/);
                  }
                  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
                  let headerIdx = lines.findIndex(l=> l.trim().startsWith('船东'));
                  if (headerIdx === -1) throw new Error('人民币费用表缺少表头');
                  const headerParts = splitFlexible(lines[headerIdx]);
                  const headers = headerParts.slice(1);
                  const rows = [];
                  for (let i = headerIdx + 1; i < lines.length; i++){
                    const raw = lines[i];
                    const parts = splitFlexible(raw);
                    if (!parts.length) continue;
                    const first = parts[0];
                    if (first === '人民币费用' || first === '编号' || first === '船东') continue;
                    const name = parts[0] || '';
                    const spec = parts[1] || '';
                    const vals = parts.slice(2);
                    const values = Array.from({length: headers.length}, (_,k)=>{
                      const v = (vals[k]||'').trim();
                      const num = Number(v.replace(/,/g,''));
                      return Number.isFinite(num) ? num : null;
                    });
                    rows.push({ name, spec, values });
                  }
                  const alias = {
                    'MSC':'MSC','MAERSK':'MSK','MSK':'MSK','CMA CGM':'CMA','CMA':'CMA','COSCO':'COSCO','HAPAG-LLOYD':'HPL','HPL':'HPL','ONE':'ONE',
                    'EVERGREEN':'EMC','EMC':'EMC','HMM':'HMM','ZIM':'ZIM','YANG MING':'YML','YML':'YML','OOCL':'OOCL','PIL':'PIL',
                    'WAN HAI':'万海','WHL':'万海','KMTC':'KMTC','TS LINES':'TSL','TSL':'TSL','RCL':'RCL','SITC':'海丰','海丰':'海丰',
                    'CHANGJIN':'长锦','CJ':'长锦','CK':'CK','NANXING':'南星','南星':'南星'
                  };
                  const upper = (carrier||'').toString().trim().toUpperCase();
                  let carrierToken = alias[upper] || carrier || '';
                  if (!headers.includes(carrierToken)){
                    const m = shippingLinesMap && shippingLinesMap[upper];
                    const code = m && (m.code || '').toUpperCase();
                    const codeAlias = alias[code] || code;
                    if (headers.includes(codeAlias)) carrierToken = codeAlias;
                  }
                  if (!headers.includes(carrierToken)){
                    const hit = headers.find(h=> h.toUpperCase() === upper || upper.includes(h.toUpperCase()) || h.toUpperCase().includes(upper));
                    carrierToken = hit || headers[0] || '';
                  }
                  const idx = headers.indexOf(carrierToken);
                  if (idx < 0) throw new Error('未找到匹配的船东列');
                  const knownBillNames = new Set(['预配舱单','文件','电放','SWB','订舱服务费']);
                  let unit20Sum = 0, unit40Sum = 0, billSum = 0;
                  rows.forEach(r=>{
                    const val = r.values[idx];
                    if (val === null) return;
                    const specU = (r.spec||'').toUpperCase();
                    if (specU === 'BILL' || knownBillNames.has(r.name)) { billSum += val; }
                    else if (specU.includes('40') || specU.includes('HC')) { unit40Sum += val; }
                    else { unit20Sum += val; }
                  });
                  const c20 = Number(qty20||0);
                  const c40All = Number(qty40||0) + Number(qty40hq||0);
                  const sub20 = unit20Sum * c20;
                  const sub40 = unit40Sum * c40All;
                  const total = sub20 + sub40 + billSum;
                  const rowsHtml = [];
                  if (c20 > 0){
                    rowsHtml.push(`<tr>
                      <td class=\"px-3 py-2\">20GP 地面费合计（按箱）</td>
                      <td class=\"px-3 py-2 text-right\">${c20}</td>
                      <td class=\"px-3 py-2 text-right\">${unit20Sum.toFixed(2)}</td>
                      <td class=\"px-3 py-2 text-right\">${sub20.toFixed(2)}</td>
                    </tr>`);
                  }
                  if (c40All > 0){
                    rowsHtml.push(`<tr>
                      <td class=\"px-3 py-2\">40GP/HQ 地面费合计（按箱）</td>
                      <td class=\"px-3 py-2 text-right\">${c40All}</td>
                      <td class=\"px-3 py-2 text-right\">${unit40Sum.toFixed(2)}</td>
                      <td class=\"px-3 py-2 text-right\">${sub40.toFixed(2)}</td>
                    </tr>`);
                  }
                  rowsHtml.push(`<tr>
                    <td class=\"px-3 py-2\">按票（BL）合计</td>
                    <td class=\"px-3 py-2 text-right\">1</td>
                    <td class=\"px-3 py-2 text-right\">${billSum.toFixed(2)}</td>
                    <td class=\"px-3 py-2 text-right\">${billSum.toFixed(2)}</td>
                  </tr>`);
                  return `
                    <div class=\"mt-3 border border-dashed rounded-md overflow-hidden\">
                      <table class=\"w-full text-sm\">
                        <thead class=\"bg-gray-50\">
                          <tr>
                            <th class=\"px-3 py-2 text-left\">费用类别</th>
                            <th class=\"px-3 py-2 text-right\">数量</th>
                            <th class=\"px-3 py-2 text-right\">单价（RMB）</th>
                            <th class=\"px-3 py-2 text-right\">小计（RMB）</th>
                          </tr>
                        </thead>
                        <tbody>${rowsHtml.join('')}</tbody>
                        <tfoot class=\"bg-gray-50\">
                          <tr>
                            <td class=\"px-3 py-2 text-right font-bold\" colspan=\"3\">合计（RMB）</td>
                            <td class=\"px-3 py-2 text-right font-bold text-primary\">${total.toFixed(2)}</td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>`;
                } catch(e){
                  console.warn('人民币费用明细计算失败，回退为固定费用栅格显示', e);
                  const fees = {
                    thc: Number(localStorage.getItem('fees_thc') || 0),
                    port: Number(localStorage.getItem('fees_port') || 0),
                    seal: Number(localStorage.getItem('fees_seal') || 0),
                    doc: Number(localStorage.getItem('fees_doc') || 0),
                    vgm: Number(localStorage.getItem('fees_vgm') || 0),
                    sec: Number(localStorage.getItem('fees_sec') || 0),
                    chc: Number(localStorage.getItem('fees_chc') || 0),
                    equip: Number(localStorage.getItem('fees_equip') || 0),
                    manifest: Number(localStorage.getItem('fees_manifest') || 0),
                  };
                  const sum = Object.values(fees).reduce((s,v)=> s + (Number(v)||0), 0);
                  return `
                    <div class=\"mt-3 border border-dashed rounded-md p-3\">
                      <div class=\"font-bold text-gray-600 mb-2\">地面费用（人民币）</div>
                      <div class=\"grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2\">
                        <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">THC</span><span class=\"font-medium\">${fees.thc.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">港杂</span><span class=\"font-medium\">${fees.port.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">铅封</span><span class=\"font-medium\">${fees.seal.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">文件费</span><span class=\"font-medium\">${fees.doc.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">VGM</span><span class=\"font-medium\">${fees.vgm.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify-between border-b border-dashed pb-1\"><span class=\"text-gray-600\">安保</span><span class=\"font-medium\">${fees.sec.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify之间 border-b border-dashed pb-1\"><span class=\"text-gray-600\">CHC</span><span class=\"font-medium\">${fees.chc.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify之间 border-b border-dashed pb-1\"><span class=\"text-gray-600\">设备</span><span class=\"font-medium\">${fees.equip.toFixed(2)}</span></div>
                        <div class=\"flex items-center justify之间\"><span class=\"text-gray-600\">舱单</span><span class=\"font-medium\">${fees.manifest.toFixed(2)}</span></div>
                      </div>
                      <div class=\"mt-2 flex items-center justify-end text-sm\">
                        <span class=\"font-bold text-gray-700 mr-2\">合计（RMB）</span>
                        <span class=\"font-bold text-primary\">${sum.toFixed(2)}</span>
                      </div>
                    </div>`;
                }
              })(data.carrier, data.qty20, data.qty40, data.qty40hq);
              const cont = document.getElementById('rmb-fees-container');
              if (cont) cont.innerHTML = html;
            } catch(e){ console.warn('构建人民币费用表失败', e); }
          })();
          if (quoteEditMode) bindEditHandlers();
        };
      }

      // 编辑模式下绑定输入事件以实时计算合计，并允许保存到本地存储
      function bindEditHandlers(){
        const r20 = document.getElementById('rate20Input');
        const r40 = document.getElementById('rate40gpInput');
        const r40hq = document.getElementById('rate40hqInput');
        const sub20 = document.getElementById('sub20');
        const sub40gp = document.getElementById('sub40gp');
        const sub40hq = document.getElementById('sub40hq');
        const usdTotal = document.getElementById('usd-total');
        const feeIds = ['fee-thc','fee-port','fee-seal','fee-doc','fee-vgm','fee-sec','fee-chc','fee-equip','fee-manifest'];
        const feesTotalEl = document.getElementById('fees-total');

        function recalcUSD(){
          const v20 = Number(r20?.value || data.rate20 || 0);
          const v40 = Number(r40?.value || data.rate40gp || 0);
          const v40h = Number(r40hq?.value || (data.rate40hq||data.rate40gp) || 0);
          if (sub20) sub20.textContent = (data.qty20 * v20).toFixed(2);
          if (sub40gp) sub40gp.textContent = (data.qty40 * v40).toFixed(2);
          if (sub40hq) sub40hq.textContent = (data.qty40hq * v40h).toFixed(2);
          const total = (data.qty20 * v20) + (data.qty40 * v40) + (data.qty40hq * v40h);
          if (usdTotal) usdTotal.textContent = total.toFixed(2);
        }
        function recalcFees(){
          // 若为旧版固定费栅格，支持编辑并汇总；新版表格基于TXT计算，不提供逐项编辑
          let sum = 0;
          feeIds.forEach(id=>{ const el = document.getElementById(id); if (el) sum += Number(el.value||0); });
          if (feesTotalEl) feesTotalEl.textContent = sum.toFixed(2);
        }
        [r20,r40,r40hq].forEach(el=>{ if (el) el.addEventListener('input', recalcUSD); });
        feeIds.forEach(id=>{ const el = document.getElementById(id); if (el) el.addEventListener('input', recalcFees); });

        // 保存修改到本地存储，便于后续导出/打印复用
        const saveBtnId = 'quote-edit-save';
        let saveBtn = document.getElementById(saveBtnId);
        if (!saveBtn) {
          const footer = modal.querySelector('.border-t');
          if (footer) {
            const btn = document.createElement('button');
            btn.id = saveBtnId;
            btn.className = 'btn-secondary px-3 py-1 text-sm';
            btn.textContent = '保存修改';
            btn.addEventListener('click', ()=>{
              if (r20) localStorage.setItem('edited_rate20', String(r20.value||data.rate20||0));
              if (r40) localStorage.setItem('edited_rate40gp', String(r40.value||data.rate40gp||0));
              if (r40hq) localStorage.setItem('edited_rate40hq', String(r40hq.value||data.rate40hq||data.rate40gp||0));
              feeIds.forEach(id=>{ const el = document.getElementById(id); if (el) localStorage.setItem('edited_'+id, String(el.value||0)); });
              alert('已保存修改到本地（演示版）。打印或导出时将按当前显示值进行。');
            });
            footer.appendChild(btn);
          }
        }
      }

      // 会员水印控制：演示从 localStorage 读取 is_paid_member（复用已声明的 isPaid）
      const watermark = document.getElementById('quote-modal-watermark');
      if (watermark) {
        const domain = (localStorage.getItem('member_company_domain') || window.location.hostname || 'www.yxtrans.com');
        const wmText = `${companyName}-${domain}`;
        // 生成斜着且重复的多行水印（更清晰但不影响阅读）
        const svg = `
          <svg xmlns='http://www.w3.org/2000/svg' width='400' height='240'>
            <g opacity='0.14' transform='rotate(-25 200 120)'>
              <text x='0' y='80' font-size='20' fill='#7c3aed' font-family='Arial, Helvetica, sans-serif'>${wmText}</text>
              <text x='0' y='140' font-size='20' fill='#7c3aed' font-family='Arial, Helvetica, sans-serif'>${wmText}</text>
              <text x='0' y='200' font-size='20' fill='#7c3aed' font-family='Arial, Helvetica, sans-serif'>${wmText}</text>
            </g>
          </svg>`;
        const url = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        const override = (localStorage.getItem('wm_dev_override') || '').trim();
        watermark.style.display = override === 'on' ? 'block' : (override === 'off' ? 'none' : (isPaid ? 'none' : 'block'));
        watermark.style.backgroundImage = `url('${url}')`;
        watermark.style.backgroundRepeat = 'repeat';
        watermark.style.backgroundSize = '320px 240px';
        watermark.style.opacity = '1'; // 清晰一些，但文字本身在SVG中已设置透明度
        watermark.style.zIndex = '20'; // 置于内容之上以确保可见（pointer-events-none 不影响点击）
      }

      overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
    }

    function ensureQuoteModal(){
      if (document.getElementById('quote-modal')) return;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div id="quote-modal-overlay" class="hidden fixed inset-0 bg-black/40 z-40"></div>
        <div id="quote-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="relative bg-white w-full max-w-2xl rounded-lg shadow-lg border">
            <!-- 水印层（非付费会员显示） -->
            <div id="quote-modal-watermark" class="pointer-events-none absolute inset-0 opacity-10"></div>
            <div class="px-4 py-3 border-b flex items-center justify-between">
              <h3 class="text-lg font-bold">报价单</h3>
              <div class="flex items-center gap-2">
                <button id="quote-modal-edit" class="text-xs px-2 py-1 border rounded text-gray-600 hover:text-gray-800 hover:border-gray-400" title="仅 Pro 及以上会员可修改报价">修改报价</button>
                <button id="quote-modal-wm-toggle" class="text-xs px-2 py-1 border rounded text-gray-600 hover:text-gray-800 hover:border-gray-400" title="开发模式：切换水印显示">水印: 正常</button>
                <button id="quote-modal-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <div class="p-4 relative">
              <div id="quote-modal-body" class="relative"></div>
              <div id="quote-modal-summary" class="mt-3 text-xs text-gray-500"></div>
            </div>
            <div class="px-4 py-3 border-t flex justify-end gap-2">
              <button id="quote-modal-export" class="btn-secondary px-3 py-1 text-sm">导出PNG</button>
              <button id="quote-modal-print" class="btn-secondary px-3 py-1 text-sm">打印</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(wrapper);

      const closeBtn = document.getElementById('quote-modal-close');
      const overlay = document.getElementById('quote-modal-overlay');
      if (closeBtn) closeBtn.addEventListener('click', hideQuoteModal);
      if (overlay) overlay.addEventListener('click', hideQuoteModal);

      // 开发模式水印开关（URL参数 wm=on/off 设初始状态，按钮在三态间切换：正常/开/关）
      const wmToggleBtn = document.getElementById('quote-modal-wm-toggle');
      if (wmToggleBtn) {
        const params = new URLSearchParams(window.location.search);
        const init = (params.get('wm') || '').trim();
        if (init === 'on' || init === 'off') {
          localStorage.setItem('wm_dev_override', init);
        }
        const cur = (localStorage.getItem('wm_dev_override') || '').trim();
        wmToggleBtn.textContent = cur === 'on' ? '水印: 开' : (cur === 'off' ? '水印: 关' : '水印: 正常');
        wmToggleBtn.addEventListener('click', () => {
          const current = (localStorage.getItem('wm_dev_override') || '').trim();
          const next = current === 'on' ? 'off' : (current === 'off' ? '' : 'on');
          if (next) localStorage.setItem('wm_dev_override', next); else localStorage.removeItem('wm_dev_override');
          const label = next === 'on' ? '水印: 开' : (next === 'off' ? '水印: 关' : '水印: 正常');
          wmToggleBtn.textContent = label;
          updateWatermarkVisibility();
        });
      }

      const exportBtn = document.getElementById('quote-modal-export');
      const printBtn = document.getElementById('quote-modal-print');
      if (exportBtn) exportBtn.addEventListener('click', exportQuoteAsImage);
      if (printBtn) printBtn.addEventListener('click', ()=>window.print());
    }

    function hideQuoteModal(){
      document.getElementById('quote-modal')?.classList.add('hidden');
      document.getElementById('quote-modal-overlay')?.classList.add('hidden');
    }

    // 开发模式：根据 wm_dev_override 与 is_paid_member 立即应用水印显示/隐藏
    function updateWatermarkVisibility(){
      const watermark = document.getElementById('quote-modal-watermark');
      if (!watermark) return;
      const isPaid = !!JSON.parse(localStorage.getItem('is_paid_member') || 'false');
      const override = (localStorage.getItem('wm_dev_override') || '').trim();
      watermark.style.display = override === 'on' ? 'block' : (override === 'off' ? 'none' : (isPaid ? 'none' : 'block'));
    }

    // 简易导出：使用浏览器截图打印替代；如需纯前端导出PNG，可后续接入 html2canvas
    function exportQuoteAsImage(){
      alert('演示版：请使用浏览器截图或打印为PDF。后续可接入 html2canvas 进行PNG导出。');
    }

    // ================= 新增：批量报价与图表 =================
    // 批量报价弹窗（展示当前筛选结果的多条）
    function ensureBatchQuoteModal(){
      if (document.getElementById('batch-quote-modal')) return;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div id="batch-quote-overlay" class="hidden fixed inset-0 bg-black/40 z-40"></div>
        <div id="batch-quote-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="relative bg-white w-full max-w-4xl rounded-lg shadow-lg border">
            <div id="batch-quote-watermark" class="pointer-events-none absolute inset-0 opacity-10"></div>
            <div class="px-4 py-3 border-b flex items-center justify-between">
              <h3 class="text-lg font-bold">运费报价单（批量）</h3>
              <div class="flex items-center gap-2">
                <button id="batch-quote-wm-toggle" class="text-xs px-2 py-1 border rounded text-gray-600 hover:text-gray-800 hover:border-gray-400" title="开发模式：切换水印显示">水印: 正常</button>
                <button id="batch-quote-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <div class="p-4 relative">
              <div id="batch-quote-body" class="relative"></div>
              <div id="batch-quote-summary" class="mt-3 text-xs text-gray-500"></div>
            </div>
            <div class="px-4 py-3 border-t flex justify-end gap-2">
              <button id="batch-quote-export" class="btn-secondary px-3 py-1 text-sm">导出PNG</button>
              <button id="batch-quote-print" class="btn-secondary px-3 py-1 text-sm">打印</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(wrapper);

      const closeBtn = document.getElementById('batch-quote-close');
      const overlay = document.getElementById('batch-quote-overlay');
      if (closeBtn) closeBtn.addEventListener('click', hideBatchQuoteModal);
      if (overlay) overlay.addEventListener('click', hideBatchQuoteModal);

      // 开发模式水印三态切换
      const wmToggleBtn = document.getElementById('batch-quote-wm-toggle');
      if (wmToggleBtn) {
        const params = new URLSearchParams(window.location.search);
        const init = (params.get('wm') || '').trim();
        if (init === 'on' || init === 'off') {
          localStorage.setItem('wm_dev_override', init);
        }
        const cur = (localStorage.getItem('wm_dev_override') || '').trim();
        wmToggleBtn.textContent = cur === 'on' ? '水印: 开' : (cur === 'off' ? '水印: 关' : '水印: 正常');
        wmToggleBtn.addEventListener('click', () => {
          const current = (localStorage.getItem('wm_dev_override') || '').trim();
          const next = current === 'on' ? 'off' : (current === 'off' ? '' : 'on');
          if (next) localStorage.setItem('wm_dev_override', next); else localStorage.removeItem('wm_dev_override');
          const label = next === 'on' ? '水印: 开' : (next === 'off' ? '水印: 关' : '水印: 正常');
          wmToggleBtn.textContent = label;
          updateBatchWatermarkVisibility();
        });
      }

      const exportBtn = document.getElementById('batch-quote-export');
      const printBtn = document.getElementById('batch-quote-print');
      if (exportBtn) exportBtn.addEventListener('click', exportQuoteAsImage);
      if (printBtn) printBtn.addEventListener('click', ()=>window.print());
    }

    function hideBatchQuoteModal(){
      document.getElementById('batch-quote-modal')?.classList.add('hidden');
      document.getElementById('batch-quote-overlay')?.classList.add('hidden');
    }

    async function showBatchQuoteModal(){
      ensureBatchQuoteModal();
      const modal = document.getElementById('batch-quote-modal');
      const overlay = document.getElementById('batch-quote-overlay');
      const body = document.getElementById('batch-quote-body');
      const pageInfo = document.getElementById('batch-quote-summary');
      if (!modal || !overlay || !body || !pageInfo) return;

      const companyName = (localStorage.getItem('member_company_name') || '').trim() || '公司名称（可修改）';
      const logoUrl = (localStorage.getItem('member_company_logo') || '').trim() || '/assets/images/logo.webp';
      const now = new Date();
      const todayStr = now.toLocaleDateString('zh-CN');
      const salesInfo = (localStorage.getItem('sales_contact') || '').trim() || '张三 / 138-0000-0000';
      const headerHtml = `
        <div class="border-b border-dashed pb-2">
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
              <img src="${logoUrl}" alt="logo" class="h-6 w-6 object-contain"/>
              <span class="font-bold">${companyName}</span>
            </div>
            <div class="text-base font-bold">运费报价单（批量）</div>
          </div>
          <div class="mt-2 flex items-center justify-between gap-4 text-xs text-gray-600">
            <div class="flex-1">业务员 ${salesInfo}</div>
            <div class="flex-1 text-right">日期：${todayStr}</div>
          </div>
        </div>`;

      let rowsHtml = '';
      const list = filteredQuotes || [];
      if (list.length === 0){
        rowsHtml = `<div class=\"px-3 py-4 text-center text-gray-500\">暂无可生成的报价内容，请先查询出结果</div>`;
      } else {
        rowsHtml = `
          <table class=\"w-full text-sm mt-3 border\">
            <thead class=\"bg-gray-50\">
              <tr>
                <th class=\"px-3 py-2 text-left\">序号</th>
                <th class=\"px-3 py-2 text-left\">起运港</th>
                <th class=\"px-3 py-2 text-left\">目的港</th>
                <th class=\"px-3 py-2 text-left\">船东</th>
                <th class=\"px-3 py-2 text-right\">20GP（USD）</th>
                <th class=\"px-3 py-2 text-right\">40GP/HQ（USD）</th>
                <th class=\"px-3 py-2 text-left\">开船</th>
                <th class=\"px-3 py-2 text-left\">预计截单时间</th>
                <th class=\"px-3 py-2 text-left\">预计截关时间</th>
                <th class=\"px-3 py-2 text-left\">预计到港时间</th>
                <th class=\"px-3 py-2 text-left\">备注</th>
              </tr>
            </thead>
            <tbody>
              ${list.map((q,idx)=>{
                const c = (q.carrier||'未知船东');
                const r20 = Number(q.rate20gp||0).toFixed(2);
                const r40 = Number(q.rate40gp||0).toFixed(2);
                return `<tr>
                  <td class=\"px-3 py-2\">${idx+1}</td>
                  <td class=\"px-3 py-2\">${q.origin||'-'}</td>
                  <td class=\"px-3 py-2\">${q.destination||'-'}</td>
                  <td class=\"px-3 py-2\">${c}</td>
                  <td class=\"px-3 py-2 text-right\">${r20}</td>
                  <td class=\"px-3 py-2 text-right\">${r40}</td>
                  <td class=\"px-3 py-2\">${q.sailing||''}</td>
                  <td class=\"px-3 py-2\">${q.cutoff_doc || q.cutoffDoc || '-'}</td>
                  <td class=\"px-3 py-2\">${q.cutoff_customs || q.cutoffCustoms || '-'}</td>
                  <td class=\"px-3 py-2\">${q.eta || q.ETA || '-'}</td>
                  <td class=\"px-3 py-2\">${q.remark||''}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>`;
      }

      // 加载人民币（地面）费用：基于 data/pricing/fees_rmb_sample.csv
      const rmbFees = await (async()=>{
        try {
          const res = await fetch('/data/pricing/fees_rmb_sample.csv');
          if (!res.ok) throw new Error('无法加载人民币费用CSV');
          const text = await res.text();
          const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
          const body = lines.slice(1);
          return body.map(l=>{
            const parts = l.split(',');
            return { port: (parts[0]||'').trim(), name: (parts[1]||'').trim(), amount: (parts[2]||'').trim(), scope: (parts[3]||'').trim(), remark: (parts[4]||'').trim() };
          });
        } catch(e){ console.warn('加载人民币费用失败', e); return []; }
      })();

      // 若涉及多个船东，仅写第一个船东的人民币收费，并给出提示
      const firstCarrier = list.length ? (list[0].carrier||'未知船东') : '';
      const rmbTableTxt = await __buildRmbTableFromTXT(firstCarrier, (list.length > 1));
      // 选择一个参考港口：以出现次数最多的起运港为准
      const originCount = {};
      (list||[]).forEach(q=>{ const p=(q.origin||'').trim(); if (!p) return; originCount[p]=(originCount[p]||0)+1; });
      const dominantOrigin = Object.entries(originCount).sort((a,b)=> b[1]-a[1])[0]?.[0] || (list[0]?.origin||'');
      const feesForOrigin = rmbFees.filter(f=> f.port === dominantOrigin);
      const feesTitle = `人民币（地面）费用（港口：${dominantOrigin||'未识别'}；示例：${firstCarrier||''}）`;
      const rmbTable = feesForOrigin.length ? `
        <div class=\"mt-4\">
          <div class=\"text-sm font-semibold mb-2\">${feesTitle}</div>
          <table class=\"w-full text-sm border\">
            <thead class=\"bg-gray-50\">
              <tr>
                <th class=\"px-3 py-2 text-left\">费用名称</th>
                <th class=\"px-3 py-2 text-right\">金额（RMB）</th>
                <th class=\"px-3 py-2 text-left\">适用范围</th>
                <th class=\"px-3 py-2 text-left\">备注</th>
              </tr>
            </thead>
            <tbody>
              ${feesForOrigin.map(f=>`
                <tr>
                  <td class=\"px-3 py-2\">${f.name}</td>
                  <td class=\"px-3 py-2 text-right\">${f.amount}</td>
                  <td class=\"px-3 py-2\">${f.scope}</td>
                  <td class=\"px-3 py-2\">${f.remark}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div class=\"mt-1 text-xs text-gray-500\">当报价表涉及的船东较多时，仅以上述第一个船东（${firstCarrier||''}）的人民币收费为示例，其他船东的人民币收费请联系销售。</div>
        </div>
      ` : `
        <div class=\"mt-4\">
          <div class=\"text-sm font-semibold mb-2\">${feesTitle}</div>
          <div class=\"text-xs text-gray-500\">当前港口暂无人民币费用样例数据，请联系销售获取详细费用。</div>
        </div>
      `;

      // 备注区（按你的要求）：
      const notes = `
        <div class=\"mt-4 text-xs text-gray-700 leading-6\">
          <div>备注：</div>
          <div>1. 海运市场运价波动频繁，以上报价仅供参考，不做结算依据，请联系销售确认。</div>
          <div>2. 截单、截关时，开船时间以实际订舱操作通知为准。</div>
          <div>3. 航程为预计时间，不作为到港时间的法律依据，请以船东实际航程为准。</div>
        </div>
      `;

      body.innerHTML = headerHtml + rowsHtml + (typeof rmbTableTxt !== 'undefined' && rmbTableTxt ? rmbTableTxt : rmbTable) + notes;
      pageInfo.textContent = `共 ${list.length} 条记录`;

      // 水印控制
      const watermark = document.getElementById('batch-quote-watermark');
      if (watermark) {
        const companyName2 = (localStorage.getItem('member_company_name') || '').trim() || '公司名称（可修改）';
        const domain = (localStorage.getItem('member_company_domain') || window.location.hostname || 'www.yxtrans.com');
        const wmText = `${companyName2}-${domain}`;
        const svg = `
          <svg xmlns='http://www.w3.org/2000/svg' width='400' height='240'>
            <g opacity='0.14' transform='rotate(-25 200 120)'>
              <text x='0' y='80' font-size='20' fill='#7c3aed' font-family='Arial, Helvetica, sans-serif'>${wmText}</text>
              <text x='0' y='140' font-size='20' fill='#7c3aed' font-family='Arial, Helvetica, sans-serif'>${wmText}</text>
              <text x='0' y='200' font-size='20' fill='#7c3aed' font-family='Arial, Helvetica, sans-serif'>${wmText}</text>
            </g>
          </svg>`;
        const url = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        const isPaid = !!JSON.parse(localStorage.getItem('is_paid_member') || 'false');
        const override = (localStorage.getItem('wm_dev_override') || '').trim();
        watermark.style.display = override === 'on' ? 'block' : (override === 'off' ? 'none' : (isPaid ? 'none' : 'block'));
        watermark.style.backgroundImage = `url('${url}')`;
        watermark.style.backgroundRepeat = 'repeat';
        watermark.style.backgroundSize = '320px 240px';
        watermark.style.opacity = '1';
        watermark.style.zIndex = '20';
      }

      overlay.classList.remove('hidden');
      modal.classList.remove('hidden');
    }

    function updateBatchWatermarkVisibility(){
      const watermark = document.getElementById('batch-quote-watermark');
      if (!watermark) return;
      const isPaid = !!JSON.parse(localStorage.getItem('is_paid_member') || 'false');
      const override = (localStorage.getItem('wm_dev_override') || '').trim();
      watermark.style.display = override === 'on' ? 'block' : (override === 'off' ? 'none' : (isPaid ? 'none' : 'block'));
    }

    // 生成按钮状态与图表渲染入口
    function updateBatchQuoteBtn(){
      const btn = document.getElementById('batch-quote-btn');
      if (!btn) return;
      const has = Array.isArray(filteredQuotes) && filteredQuotes.length > 0;
      btn.disabled = !has;
    }

    function renderTrendAndCompare(){
      const origin = (document.getElementById('pricing-origin')?.value || '').trim();
      const dest = (document.getElementById('pricing-dest')?.value || '').trim();
      renderTrendChart(origin, dest, filteredQuotes);
      renderCompareChart(filteredQuotes);
    }

    // 折线图（SVG）：基于历史与当前均值（40GP）
    function renderTrendChart(origin, dest, quotes){
      const wrap = document.getElementById('trend-chart');
      const title = document.getElementById('trend-title');
      if (!wrap || !title) return;
      title.textContent = origin && dest ? `${origin} 到 ${dest} 运费走势` : '运费走势';
      let history = {};
      try { history = JSON.parse(localStorage.getItem('freight_history_db')||'{}'); } catch {}
      const key = origin && dest ? `${origin}__${dest}` : '__default__';
      const arr = Array.isArray(history[key]) ? history[key] : [];
      const avg40 = (Array.isArray(quotes) && quotes.length>0) ? (quotes.reduce((s,q)=> s + Number(q.rate40gp||0), 0) / quotes.length) : null;
      const points = arr.slice(-8);
      if (avg40 !== null){
        const today = new Date();
        const ds = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        points.push({ date: ds, rate40gp: avg40 });
      }
      if (!points.length){ wrap.textContent = '暂无数据'; return; }
      const w = wrap.clientWidth || 600; const h = wrap.clientHeight || 200; const pad = 24;
      const min = Math.min(...points.map(p=>Number(p.rate40gp||0))); const max = Math.max(...points.map(p=>Number(p.rate40gp||0)));
      const scaleY = (v)=>{ if (max===min) return h/2; return pad + (h - 2*pad) * (1 - (v - min) / (max - min)); };
      const stepX = (w - 2*pad) / Math.max(points.length-1, 1);
      const d = points.map((p,i)=> `${pad + i*stepX},${scaleY(Number(p.rate40gp||0))}`).join(' ');
      const label = `${min.toFixed(0)} - ${max.toFixed(0)} USD (40GP)`;
      const svg = `
        <svg width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="100%" height="100%" fill="white"/>
          <polyline points="${d}" fill="none" stroke="#165DFF" stroke-width="2" />
          ${points.map((p,i)=>`<circle cx="${pad + i*stepX}" cy="${scaleY(Number(p.rate40gp||0))}" r="3" fill="#165DFF" />`).join('')}
          <text x="${pad}" y="${pad-6}" font-size="12" fill="#666">${label}</text>
        </svg>`;
      wrap.innerHTML = svg;
    }

    // 柱状图（SVG）：按船东比较，单柱合并显示 20GP（下部实心）与 40GP/40HQ（上部描边），并标注航程
    function renderCompareChart(quotes){
      const wrap = document.getElementById('compare-chart');
      const title = document.getElementById('compare-title');
      if (!wrap || !title) return;
      const groups = {};
      (quotes||[]).forEach(q=>{
        const key = (q.carrier||'未知船东');
        if (!groups[key]) groups[key] = [];
        groups[key].push(q);
      });
      const carriers = Object.keys(groups);
      if (carriers.length === 0){ wrap.textContent = '暂无数据'; return; }
      const stats = carriers.map(c=>{
        const list = groups[c];
        const avg20 = list.reduce((s,q)=> s + Number(q.rate20gp||0), 0) / list.length;
        // 40 使用 40HQ 优先，否则 40GP
        const avg40 = list.reduce((s,q)=> s + Number((q.rate40hq ?? q.rate40gp) || 0), 0) / list.length;
        // 航程：从 q.duration 抽取天数并求平均
        const daysArr = list.map(q=>{
          const m = String(q.duration||'').match(/(\d+)/);
          return m ? Number(m[1]) : null;
        }).filter(v=> v!==null);
        const days = daysArr.length ? Math.round(daysArr.reduce((s,v)=> s+v, 0) / daysArr.length) : null;
        return { carrier: c, avg20, avg40, days };
      });
      const maxV = Math.max(...stats.map(s=>Math.max(s.avg20||0, s.avg40||0)));
      const w = wrap.clientWidth || 600; const h = wrap.clientHeight || 220; const pad = 28;
      // 分组布局：每个船东一组，左侧显示价格柱（20GP+40差值），右侧显示航程柱（空心）
      const innerGap = 0;      // 组内两柱之间的间距（紧贴在一起）
      const groupGap = 16;      // 组与组之间的间距
      const available = (w - 2*pad) - groupGap * Math.max(stats.length - 1, 0) - innerGap * stats.length;
      const barW = Math.max(18, available / (stats.length * 2));
      const scaleY = (v)=>{ if (maxV<=0) return h/2; return pad + (h - 2*pad) * (1 - (v / maxV)); };
      const maxDays = Math.max(...stats.map(s=> (s.days||0)));
      const scaleYDays = (d)=>{ if (!maxDays || maxDays<=0) return h - pad; return pad + (h - 2*pad) * (1 - (d / maxDays)); };
      const palette = ['#165DFF','#22c55e','#ef4444','#f59e0b','#10b981','#8b5cf6','#06b6d4','#f97316','#84cc16','#0ea5e9'];
      const colorOf = (carrier)=>{
        const i = Math.abs([...carrier].reduce((s,ch)=> s + ch.charCodeAt(0), 0)) % palette.length;
        return palette[i];
      };
      // 船东三字母缩写显示
      const abbrOf = (carrier)=>{
        const key = String(carrier||'').toUpperCase().trim();
        const map = {
          'MSC': 'MSC',
          'MAERSK': 'MSK',
          'CMA CGM': 'CMA',
          'COSCO': 'COS',
          'COSCO SHIPPING': 'COS',
          'HAPAG-LLOYD': 'HPL',
          'HAPAG LLOYD': 'HPL',
          'ONE': 'ONE',
          'EVERGREEN': 'EMC',
          'EGLV': 'EMC',
          'HMM': 'HMM',
          'ZIM': 'ZIM',
          'OOCL': 'OOL',
          'PIL': 'PIL',
          'YANG MING': 'YML',
          'WAN HAI': 'WHL',
          'TS LINES': 'TSL',
          'RCL': 'RCL',
          'KMTC': 'KMT'
        };
        if (map[key]) return map[key];
        const letters = key.match(/[A-Z]+/g);
        const joined = letters ? letters.join('') : '';
        if (joined.length >= 3) return joined.slice(0,3);
        return 'UNK';
      };
      // 统一上下柱状的描边粗细，让视觉一致
      const STROKE_W = 2;
      let svgBars = '';
      stats.forEach((s, idx)=>{
        const xGroupStart = pad + idx * (2*barW + innerGap + groupGap);
        const xBase = xGroupStart;              // 价格柱起点（左）
        const xDays = xGroupStart + barW + innerGap; // 航程柱起点（右）
        const y20 = scaleY(s.avg20||0);
        const y40 = scaleY(s.avg40||0);
        const h20 = (h - 2*pad) - (y20 - pad);
        const deltaH = Math.max(0, (y20 - y40)); // 40部分高度
        const color = colorOf(s.carrier);
        // 下部实心（20GP）
        svgBars += `
          <rect x="${xBase}" y="${y20}" width="${barW}" height="${h20}" fill="${color}" stroke="${color}" stroke-width="${STROKE_W}" stroke-linejoin="round" />
        `;
        // 上部描边（40GP/40HQ 与 20 的差值）
        if (deltaH > 0) {
          svgBars += `
            <rect x="${xBase}" y="${y40}" width="${barW}" height="${deltaH}" fill="none" stroke="${color}" stroke-width="${STROKE_W}" stroke-linejoin="round" />
          `;
        }
        // 右侧：航程空心柱（以天数为高度，独立比例尺）
        if (s.days != null) {
          const yD = scaleYDays(s.days);
          const hD = (h - 2*pad) - (yD - pad);
          svgBars += `
            <rect x="${xDays}" y="${yD}" width="${barW}" height="${hD}" fill="none" stroke="${color}" stroke-width="${STROKE_W}" stroke-linejoin="round" />
            <text x="${xDays + barW/2}" y="${yD + Math.max(12, hD/2)}" font-size="11" text-anchor="middle" fill="${color}">${(s.days||0)}天</text>
          `;
        }
        // 底部标签：船东
        const groupCenter = xGroupStart + barW; // 两柱中点（紧贴时即左柱右缘与右柱左缘的交界中点）
        svgBars += `
          <text x="${groupCenter}" y="${h - pad + 14}" font-size="12" text-anchor="middle" fill="#333">${abbrOf(s.carrier)}</text>
        `;
        // 数值标注：根据柱高自适应字体（过小则采用竖排显示），并且航程仅显示数字
        // 20GP 实心柱
        {
          const centerX = xBase + barW/2;
          const yLabel = y20 + Math.max(12, h20/2);
          const font20 = (h20 >= 22) ? 11 : (h20 >= 16) ? 10 : 9;
          const rotate20 = h20 < 12;
          if (rotate20){
            svgBars += `
              <text x="${centerX}" y="${yLabel}" font-size="${font20}" text-anchor="middle" fill="#fff" transform="rotate(-90 ${centerX} ${yLabel})">${(s.avg20||0).toFixed(0)}</text>
            `;
          } else {
            svgBars += `
              <text x="${centerX}" y="${yLabel}" font-size="${font20}" text-anchor="middle" fill="#fff">${(s.avg20||0).toFixed(0)}</text>
            `;
          }
        }
        // 40GP/40HQ 空心差值部分
        if (deltaH > 0){
          const centerX40 = xBase + barW/2;
          const yLabel40 = y40 + Math.max(12, deltaH/2);
          const font40 = (deltaH >= 22) ? 11 : (deltaH >= 16) ? 10 : 9;
          const rotate40 = deltaH < 12;
          if (rotate40){
            svgBars += `
              <text x="${centerX40}" y="${yLabel40}" font-size="${font40}" text-anchor="middle" fill="${color}" transform="rotate(-90 ${centerX40} ${yLabel40})">${(s.avg40||0).toFixed(0)}</text>
            `;
          } else {
            svgBars += `
              <text x="${centerX40}" y="${yLabel40}" font-size="${font40}" text-anchor="middle" fill="${color}">${(s.avg40||0).toFixed(0)}</text>
            `;
          }
        } else {
          // 若差值为 0，则在顶部外侧标注
          const centerX40 = xBase + barW/2;
          const yLabelTop = y40 - 6;
          svgBars += `
            <text x="${centerX40}" y="${yLabelTop}" font-size="10" text-anchor="middle" fill="${color}">${(s.avg40||0).toFixed(0)}</text>
          `;
        }
        // 航程空心柱
        if (s.days != null){
          const yD = scaleYDays(s.days);
          const hD = (h - 2*pad) - (yD - pad);
          const centerXD = xDays + barW/2;
          const yLabelD = yD + Math.max(12, hD/2);
          const fontD = (hD >= 22) ? 9 : (hD >= 16) ? 8 : 7; // 航程字体更小一些
          const rotateD = hD < 12;
          const daysText = String(s.days||0); // 仅数字，不写“天”
          if (rotateD){
            svgBars += `
              <text x="${centerXD}" y="${yLabelD}" font-size="${fontD}" text-anchor="middle" fill="${color}" transform="rotate(-90 ${centerXD} ${yLabelD})">${daysText}</text>
            `;
          } else {
            svgBars += `
              <text x="${centerXD}" y="${yLabelD}" font-size="${fontD}" text-anchor="middle" fill="${color}">${daysText}</text>
            `;
          }
        }
      });
      const svg = `
        <svg width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="100%" height="100%" fill="white"/>
          ${svgBars}
        </svg>`;
      wrap.innerHTML = svg;
    }
    // 迁移旧报价数据到新结构（补充船公司/40HQ/航程/直航或中转）
    function migrateQuotesToNewSchema(){
      let arr;
      try { arr = JSON.parse(localStorage.getItem(QUOTES_KEY) || '[]'); } catch { arr = []; }
      if (!Array.isArray(arr) || arr.length===0) return;
      const carriers = ['MSC','MAERSK','CMA CGM','COSCO','HAPAG-LLOYD','ONE','EVERGREEN','HMM','ZIM'];
      let changed = false;
      arr = arr.map((q, idx)=>{
        const out = { ...q };
        if (out.rate40hq === undefined && out.rate40gp !== undefined){ out.rate40hq = Number(out.rate40gp) + 60; changed = true; }
        if (!out.carrier){ out.carrier = carriers[idx % carriers.length]; changed = true; }
        if (!out.duration){ out.duration = `${12 + (idx % 9)}天`; changed = true; }
        if (!out.serviceType){ out.serviceType = (idx % 2 === 0) ? '直航' : '中转'; changed = true; }
        return out;
      });
      if (changed){ localStorage.setItem(QUOTES_KEY, JSON.stringify(arr)); }
    }
  </script>
</body>
</html>
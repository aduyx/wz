<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户中心 - AI智货代</title>
  
  <!-- SEO 元数据 -->
  <meta name="description" content="AI智货代用户中心 - 管理您的账户信息、查询记录和积分。">
  <meta name="keywords" content="用户中心,账户管理,个人信息,AI智货代,国际物流">
  <meta name="author" content="AI智货代">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- 全局样式 -->
  <link rel="stylesheet" href="/assets/css/global.css">
  
  <!-- 自定义配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#0E2E88',
            accent: '#FF7D00',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .transition-custom {
        transition: all 0.3s ease;
      }
      .card-hover {
        @apply hover:shadow-lg hover:-translate-y-1 transition-custom;
      }
      .custom-gradient {
        background: linear-gradient(to right, 
          #3b82f6 0%, 
          #3b82f6 61.8%, 
          #14b8a6 80.9%, 
          #06b6d4 100%);
      }
      .text-gradient {
        background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706, #92400e);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .h2-gradient {
        background: linear-gradient(135deg, #165DFF 0%, #0E2E88 30%, #FF7D00 70%, #f59e0b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 200% 200%;
        animation: gradientShift 3s ease-in-out infinite;
      }
      @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }
      
      /* 统一按钮样式 */
      .btn-primary {
        @apply bg-primary text-white font-medium py-3 px-6 rounded-lg hover:bg-primary/90 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg;
      }
      
      .btn-secondary {
        @apply bg-gray-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-700 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg;
      }
      
      .btn-accent {
        @apply bg-yellow-500 text-black font-medium py-2 px-4 rounded-lg hover:bg-yellow-400 transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg;
      }
      .btn-sm {
        @apply text-xs py-1.5 px-2 rounded;
      }
      .input-sm {
        @apply text-xs px-2 py-1.5;
      }
      .field-compact {
        @apply md:max-w-[320px];
      }
      
      /* 强制首页使用浅色背景 */
      body {
        background-color: #f9fafb !important;
      }
      
      /* 响应式设计优化 */
      @media (max-width: 767px) {
        .hero {
          @apply py-6 px-3;
        }
        .hero__title {
          @apply text-2xl leading-tight;
        }
        .hero__subtitle {
          @apply text-base;
        }
        .container {
          @apply px-3;
        }
        .tracking-section__form {
          @apply flex-col space-y-3;
        }
        .form__select {
          @apply w-full;
        }
      }
      
      @media (max-width: 480px) {
        .hero {
          @apply py-4 px-2;
        }
        .hero__title {
          @apply text-xl;
        }
        .container {
          @apply px-2;
        }
      }
    }
  </style>
  <!-- 全局JavaScript -->
  <script src="/assets/js/global.js?v=20251114"></script>
</head>
<body class="bg-gray-50 font-sans text-dark">
  <!-- 页眉容器 -->
  <div id="header-container"></div>

  <main id="main">
    <!-- 全宽横幅 -->
    <section class="hero custom-gradient text-white py-8">
      <div class="container mx-auto px-4 text-left">
        <h1 class="hero__title text-[clamp(2rem,5vw,3.5rem)] font-bold mb-4 text-shadow">
          用户中心
        </h1>
        <p class="hero__subtitle text-[clamp(1rem,2vw,1.25rem)] max-w-3xl opacity-90">
          管理您的账户信息、查询记录和积分。
        </p>
      </div>
    </section>

    <!-- 主内容容器 -->
    <section class="container mx-auto px-4 py-8">
      <div class="flex flex-col md:flex-row gap-6 md:gap-8">
        <!-- 左侧导航菜单 - 占1/4宽度 -->
        <div class="w-full md:w-1/4">
          <div class="bg-white rounded-lg shadow-sm p-6 border border-purple-500 text-sm">
            <div class="flex items-center mb-6">
              <div id="user-avatar" class="w-16 h-16 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold bg-cover bg-center">U</div>
              <div class="ml-4">
                <h3 id="user-display-name" class="font-bold text-lg">用户名</h3>
                <p id="user-role-name" class="text-gray-600 text-sm">普通会员</p>
              </div>
            </div>
            <div class="space-y-2 mb-6">
              <div class="flex items-center gap-2 flex-nowrap">
                <input id="avatar-file" type="file" accept="image/*" class="flex-1 min-w-0 text-xs" />
                <button id="avatar-reset" class="btn-secondary btn-sm shrink-0">重置头像</button>
              </div>
              <div id="avatar-cards" class="grid grid-cols-3 gap-2"></div>
              <div id="avatar-cards-empty" class="text-xs text-gray-500 hidden-element">暂无卡片，可前往集卡博物馆获取</div>
            </div>
            
            <nav class="space-y-2">
              <a href="#section-profile" class="block py-2 px-4 rounded-lg bg-primary text-white font-medium">
                <i class="fas fa-user mr-2"></i>个人信息
              </a>
              <a href="#section-invite" class="block py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors duration-300">
                <i class="fas fa-user-plus mr-2"></i>邀请与分享
              </a>
              <a href="#section-museum" class="block py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors duration-300">
                <i class="fas fa-truck-loading mr-2"></i>我的卡片
              </a>
              <a href="#section-redeem" class="block py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors duration-300">
                <i class="fas fa-exchange-alt mr-2"></i>积分详情
              </a>
              <a href="#section-notices" class="block py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors duration-300">
                <i class="fas fa-bell mr-2"></i>消息通知
              </a>
              <a href="#section-recent" class="block py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors duration-300">
                <i class="fas fa-history mr-2"></i>最近查询记录
              </a>
            </nav>
            <div class="mt-6 bg-white rounded-lg shadow-sm p-4 border border-green-500">
              <h2 class="text-lg font-bold mb-3 h2-gradient">快捷操作</h2>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <a href="/pages/tracking/index.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-search-location text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">集装箱追踪</p>
                </a>
                <a href="/pages/schedules/index.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-ship text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">船期查询</p>
                </a>
                <a href="/pages/pricing/index.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-calculator text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">费用查询</p>
                </a>
                <a href="/pages/tools/index.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-wrench text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">工具中心</p>
                </a>
                <a href="/pages/support/faq.html#tickets" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-headset text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">客服工单</p>
                </a>
                <a href="/pages/about/news.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-newspaper text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">资讯中心</p>
                </a>
                <a href="/pages/jika-museum/index.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-images text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">集卡博物馆</p>
                </a>
                <a href="/pages/points-mall/index.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-store text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">积分商城</p>
                </a>
                
                <a href="/pages/user/upgrade.html" class="block p-3 border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-300 text-center">
                  <i class="fas fa-crown text-xl text-primary mb-1"></i>
                  <p class="text-sm font-medium">积分/会员中心</p>
                </a>
              </div>
            </div>
          </div>
        </div>
          
        <!-- 右侧内容区域 - 占3/4宽度 -->
        <div class="w-full md:w-3/4 space-y-6">
          <!-- 个人信息卡片 -->
          <div id="section-profile" class="bg-white rounded-lg shadow-sm p-6 border border-blue-500 text-sm">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold h2-gradient">个人信息</h2>
              <div class="flex items-center gap-3">
                <div class="text-sm">积分余额：<span id="profile-points" class="font-semibold">0 分</span></div>
                <a href="/pages/points-mall/index.html" class="btn-accent btn-sm">积分兑换</a>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <div class="flex items-center gap-2 flex-wrap">
                  <p id="profile-username" class="form__input flex-1 input-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600"></p>
                  <button id="btn-change-username" class="btn-secondary btn-sm">更改</button>
                  <p id="profile-registered" class="form__input shrink-0 input-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600 w-[140px] md:w-[220px]"></p>
                  <p id="profile-last-login" class="form__input shrink-0 input-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600 w-[140px] md:w-[220px]"></p>
                </div>
                <div id="change-username-panel" class="mt-2 hidden">
                  <div class="flex items-center gap-2">
                    <input id="input-new-username" type="text" class="form__input flex-1 input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm" placeholder="输入新用户名">
                    <button id="btn-save-new-username" class="btn-primary btn-sm">保存</button>
                  </div>
                  <div id="change-username-tip" class="text-xs text-gray-500 mt-1">第一次登录后可修改一次，之后每30天可修改一次</div>
                </div>
              </div>
              <div>
                <div class="flex items-center gap-2">
                  <p id="profile-role" class="form__input w-full input-sm field-compact border border-gray-300 rounded-lg bg-gray-50 text-gray-600"></p>
                  <a id="btn-upgrade" href="/pages/user/upgrade.html" class="btn-accent btn-sm"><i class="fas fa-crown mr-1"></i>升级</a>
                </div>
              </div>
              
              <div class="md:col-span-2 grid md:grid-cols-3 gap-4">
                <div><input id="input-email" type="email" placeholder="邮箱" class="form__input w-full input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"></div>
                <div><input id="input-phone" type="tel" placeholder="手机号" class="form__input w-full input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"></div>
                <div><input id="input-wechat" type="text" placeholder="微信号" class="form__input w-full input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"></div>
              </div>
              <div class="md:col-span-2 grid md:grid-cols-3 gap-4">
                <div><input id="input-company" type="text" placeholder="公司名称（准确填写，生成报价单时会显示）" class="form__input w-full input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"></div>
                <div><input id="input-realname" type="text" placeholder="姓名" class="form__input w-full input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"></div>
                <div><input id="input-title" type="text" placeholder="职务" class="form__input w-full input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm"></div>
              </div>
              <div class="md:col-span-2">
                <input id="input-address" type="text" placeholder="邮寄地址" class="form__input w-full input-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
              </div>
              
            </div>
            <div class="mt-6">
              <button id="btn-save-profile" class="btn-primary btn-sm">
                <i class="fas fa-save mr-1"></i>
                保存信息
              </button>
            </div>
          </div>

          

          <div id="section-invite" class="bg-white rounded-lg shadow-sm p-6 border border-amber-500 text-sm">
            <h2 class="text-2xl font-bold mb-4 h2-gradient">邀请与分享</h2>
            <div class="space-y-2">
              <p class="text-sm text-gray-600">我的邀请码与分享链接</p>
              <div class="flex items-center gap-2 flex-nowrap overflow-x-auto">
                <p id="invite-code-display" class="shrink-0 w-[140px] md:w-[180px] px-3 py-2 border rounded bg-gray-50 text-gray-700"></p>
                <button id="btn-generate-invite" class="btn-secondary btn-sm shrink-0">生成邀请码</button>
                <input id="invite-link-display" class="flex-1 min-w-0 px-3 py-2 border rounded bg-gray-50 text-gray-700" readonly>
                <button id="btn-copy-invite-link" class="btn-secondary btn-sm shrink-0">复制链接</button>
              </div>
              <div class="text-xs text-gray-500">分享链接指向登录/注册页，受邀用户注册后将与您的邀请码绑定。</div>
              <div class="mt-1 text-sm text-gray-700">
                <span>已邀请人数：</span><span id="invite-count" class="font-medium">0</span>
              </div>
              <div class="mt-1 text-xs text-gray-500" id="invite-rule">邀请成功注册奖励 <span id="invite-per-signup" class="font-medium">0</span> 分/人</div>
              <div class="mt-1 text-sm">累计奖励：<span id="invite-earned" class="font-semibold">0 分</span></div>
            </div>
          </div>

          <div id="section-museum" class="bg-white rounded-lg shadow-sm p-6 border border-sky-500 text-sm">
            <h2 class="text-2xl font-bold mb-4 h2-gradient">我的卡片博物馆</h2>
            <div id="tab-mycards" class="space-y-3">
              <div id="mycards-progress" class="text-sm text-gray-700"></div>
              <div id="mycards-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
              <div id="mycards-empty" class="text-xs text-gray-500 hidden-element">暂无卡片，前往集卡博物馆了解并收集卡片</div>
              <a href="/pages/jika-museum/index.html" class="inline-block text-xs text-primary hover:underline">进入集卡博物馆</a>
            </div>
          </div>
          <div id="section-redeem" class="bg-white rounded-lg shadow-sm p-6 border border-green-500 text-sm">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold h2-gradient">积分详情</h2>
              <div class="flex items-center gap-2">
                <div class="text-sm">我的总积分：<span id="my-total-points" class="font-semibold">0 分</span></div>
                <a href="/pages/points-mall/index.html" class="btn-accent btn-sm"><i class="fas fa-store mr-1"></i>积分商城</a>
              </div>
            </div>
            <div class="text-sm text-gray-700">积分获取记录</div>
            <div id="points-empty" class="text-xs text-gray-500">暂无记录</div>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white border border-gray-200">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="py-2 px-4 border-b text-left">时间</th>
                    <th class="py-2 px-4 border-b text-left">渠道</th>
                    <th class="py-2 px-4 border-b text-left">积分</th>
                    <th class="py-2 px-4 border-b text-left">说明</th>
                    <th class="py-2 px-4 border-b text-left">操作</th>
                  </tr>
                </thead>
                <tbody id="points-tbody"></tbody>
              </table>
            </div>
          </div>

          <div id="section-notices" class="bg-white rounded-lg shadow-sm p-6 border border-red-500 text-sm">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold h2-gradient">消息通知</h2>
              <div class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">未读 <span id="notice-unread-count">0</span> 条</div>
            </div>
            <div id="notices-empty" class="text-xs text-gray-500">暂无消息</div>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white border border-gray-200">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="py-2 px-4 border-b text-left">标题</th>
                    <th class="py-2 px-4 border-b text-left">时间</th>
                    <th class="py-2 px-4 border-b text-left">状态</th>
                    <th class="py-2 px-4 border-b text-left">操作</th>
                  </tr>
                </thead>
                <tbody id="notices-tbody"></tbody>
              </table>
            </div>
          </div>

          <!-- 最近查询记录 -->
          <div id="section-recent" class="bg-white rounded-lg shadow-sm p-6 border border-orange-500 text-sm">
            <h2 class="text-2xl font-bold mb-4 h2-gradient">最近查询记录</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white border border-gray-200">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="py-2 px-4 border-b text-left">查询类型</th>
                    <th class="py-2 px-4 border-b text-left">查询内容</th>
                    <th class="py-2 px-4 border-b text-left">查询时间</th>
                    <th class="py-2 px-4 border-b text-left">操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">集装箱追踪</td>
                    <td class="py-2 px-4 border-b">MSCU1234567</td>
                    <td class="py-2 px-4 border-b">2025-10-28 14:30</td>
                    <td class="py-2 px-4 border-b">
                      <a href="#" class="text-primary hover:text-primary/80">查看详情</a>
                    </td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">船期查询</td>
                    <td class="py-2 px-4 border-b">上海 → 洛杉矶</td>
                    <td class="py-2 px-4 border-b">2025-10-27 09:15</td>
                    <td class="py-2 px-4 border-b">
                      <a href="#" class="text-primary hover:text-primary/80">查看详情</a>
                    </td>
                  </tr>
                  <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">费用查询</td>
                    <td class="py-2 px-4 border-b">上海 → 纽约</td>
                    <td class="py-2 px-4 border-b">2025-10-26 16:45</td>
                    <td class="py-2 px-4 border-b">
                      <a href="#" class="text-primary hover:text-primary/80">查看详情</a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mt-4 text-center">
              <a href="#" class="text-primary hover:text-primary/80 font-medium">查看全部查询记录</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 页脚容器 -->
  <div id="footer-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      loadComponent('header-container', '/components/header.html');
      loadComponent('footer-container', '/components/footer.html');
      initUserCenter();
    });
    function getRegistry(){ try { return JSON.parse(localStorage.getItem('yx_users')||'{}'); } catch(e){ return {}; } }
    function setRegistry(obj){ try { localStorage.setItem('yx_users', JSON.stringify(obj)); } catch(e){} }
    function getPoints(){ try { return JSON.parse(localStorage.getItem('yx_points')||'{}'); } catch(e){ return {}; } }
    function setPoints(obj){ try { localStorage.setItem('yx_points', JSON.stringify(obj)); } catch(e){} }
    function fmtDate(ts){ try { var d=new Date(ts); var y=d.getFullYear(); var m=('0'+(d.getMonth()+1)).slice(-2); var da=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+da; } catch(e){ return ''; } }
    function isCNPhone(v){ return /^1[3-9]\d{9}$/.test(v); }
    function isWechat(v){ return /^[a-zA-Z][-_a-zA-Z0-9]{5,19}$/.test(v); }
    function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
    function initUserCenter(){
      var raw = localStorage.getItem('yx_user');
      if (!raw){ window.location.href = '/pages/user/login.html'; return; }
      var u; try { u = JSON.parse(raw); } catch(e){ window.location.href = '/pages/user/login.html'; return; }
      var uname = u.username; var role = u.role||'user';
      var reg = getRegistry(); var info = reg[uname]||{};
      var pts = getPoints(); var p = pts[uname]; if (typeof p!=='number') p = 0;
      var roleName = role==='super_admin' ? '超级管理员' : '普通会员';
      var elName = document.getElementById('user-display-name'); if (elName) elName.textContent = uname;
      var elRoleName = document.getElementById('user-role-name'); if (elRoleName) elRoleName.textContent = roleName;
      var elPU = document.getElementById('profile-username'); if (elPU) elPU.textContent = '用户名：' + uname;
      var elPR = document.getElementById('profile-role'); if (elPR) elPR.textContent = '会员等级：' + roleName;
      var regAt = info.registered_at || u.login_at || Date.now();
      var elPRg = document.getElementById('profile-registered'); if (elPRg) elPRg.textContent = '注册时间：' + fmtDate(regAt);
      var elPLL = document.getElementById('profile-last-login'); if (elPLL) elPLL.textContent = '上次登录：' + fmtDate(u.login_at || Date.now());
      var elPts = document.getElementById('profile-points'); if (elPts) elPts.textContent = String(p) + ' 分';
      var inputEmail = document.getElementById('input-email'); if (inputEmail) inputEmail.value = info.email || '';
      var inputPhone = document.getElementById('input-phone'); if (inputPhone) inputPhone.value = info.phone || '';
      var inputWechat = document.getElementById('input-wechat'); if (inputWechat) inputWechat.value = info.wechat || '';
      var inputRealname = document.getElementById('input-realname'); if (inputRealname) inputRealname.value = info.realname || '';
      var inputTitle = document.getElementById('input-title'); if (inputTitle) inputTitle.value = info.title || '';
      var inputCompany = document.getElementById('input-company'); if (inputCompany) inputCompany.value = info.company || '';
      var inputAddress = document.getElementById('input-address'); if (inputAddress) inputAddress.value = info.address || '';
      renderAvatar(info, uname);
      initAvatarEvents(info, uname, reg);
      initUsernameChange(info, uname, u, reg, pts);
      var saveBtn = document.getElementById('btn-save-profile');
      if (saveBtn) saveBtn.addEventListener('click', function(){
        var email = inputEmail ? inputEmail.value.trim() : '';
        var phone = inputPhone ? inputPhone.value.trim() : '';
        var wechat = inputWechat ? inputWechat.value.trim() : '';
        var realname = inputRealname ? inputRealname.value.trim() : '';
        var title = inputTitle ? inputTitle.value.trim() : '';
        var company = inputCompany ? inputCompany.value.trim() : '';
        var address = inputAddress ? inputAddress.value.trim() : '';
        if (email && !isEmail(email)){ alert('邮箱格式不正确'); return; }
        if (phone && !isCNPhone(phone)){ alert('手机号格式不正确'); return; }
        if (wechat && !isWechat(wechat)){ alert('微信号格式不正确'); return; }
        if (realname && info.realname && realname !== info.realname){ var last = info.realname_last_change_at || 0; var now = Date.now(); var need = 30*24*60*60*1000; if (last && (now - last) < need){ alert('姓名修改过于频繁，请稍后再试'); return; } info.realname_last_change_at = now; }
        reg[uname] = Object.assign({}, info, { email: email, phone: phone, wechat: wechat, realname: realname, title: title, company: company, address: address });
        setRegistry(reg);
        alert('个人信息已保存');
      });
      updateInviteCard(info, reg);
      updateMuseumSection(info, uname, reg, pts);
      var elTP = document.getElementById('my-total-points'); if (elTP) elTP.textContent = String(p) + ' 分';
      renderNotices(uname);
      var btnCopyLink = document.getElementById('btn-copy-invite-link'); if (btnCopyLink) btnCopyLink.addEventListener('click', function(){ var input = document.getElementById('invite-link-display'); var v = input ? input.value : ''; if (!v){ alert('暂无分享链接'); return; } navigator.clipboard && navigator.clipboard.writeText(v).then(function(){ alert('已复制链接'); }).catch(function(){ alert('复制失败'); }); });
      var navLinks = document.querySelectorAll('nav a');
      navLinks.forEach(function(link){ link.addEventListener('click', function(e){ e.preventDefault(); var href = this.getAttribute('href'); if (href && href.charAt(0)==='#'){ var target = document.querySelector(href); if (target){ target.scrollIntoView({ behavior: 'smooth', block: 'start' }); } } navLinks.forEach(function(l){ l.classList.remove('bg-primary','text-white'); }); this.classList.add('bg-primary','text-white'); }); });
    }

    function renderAvatar(info, uname){
      var ua = document.getElementById('user-avatar');
      var av = info.avatar || '';
      if (ua){
        if (av){ ua.style.backgroundImage = 'url(' + av + ')'; ua.textContent = ''; }
        else { ua.style.backgroundImage = ''; ua.textContent = (uname||'U').slice(0,1).toUpperCase(); }
      }
      var cardsWrap = document.getElementById('avatar-cards');
      var empty = document.getElementById('avatar-cards-empty');
      if (cardsWrap){
        cardsWrap.innerHTML = '';
        var list = [];
        try { list = JSON.parse(localStorage.getItem('user_avatar_cards')||'[]'); } catch(e){}
        if (!Array.isArray(list) || list.length===0){ try { list = JSON.parse(localStorage.getItem('owned_cards')||'[]'); } catch(e){} }
        if (!Array.isArray(list) || list.length===0){ try { list = JSON.parse(localStorage.getItem('jika_owned_cards')||'[]'); } catch(e){} }
        if (Array.isArray(list) && list.length){
          if (empty) empty.style.display = 'none';
          list.slice(0,9).forEach(function(url){
            var btn = document.createElement('button');
            btn.className = 'border rounded overflow-hidden';
            btn.innerHTML = '<img src="' + url + '" class="w-full h-16 object-cover" />';
            btn.addEventListener('click', function(){
              var reg = getRegistry(); var u = JSON.parse(localStorage.getItem('yx_user')||'{}'); var name = u.username; var info = reg[name]||{}; info.avatar = url; reg[name] = info; setRegistry(reg); renderAvatar(info, name);
            });
            cardsWrap.appendChild(btn);
          });
        } else {
          if (empty) empty.style.display = 'block';
        }
      }
    }

    function initAvatarEvents(info, uname, reg){
      var file = document.getElementById('avatar-file');
      if (file) file.addEventListener('change', function(){
        var f = file.files && file.files[0]; if (!f) return;
        var r = new FileReader();
        r.onload = function(){ info.avatar = r.result; reg[uname] = info; setRegistry(reg); renderAvatar(info, uname); };
        r.readAsDataURL(f);
      });
      var reset = document.getElementById('avatar-reset');
      if (reset) reset.addEventListener('click', function(){ delete info.avatar; reg[uname] = info; setRegistry(reg); renderAvatar(info, uname); });
    }

    function initUsernameChange(info, uname, u, reg, pts){
      var btn = document.getElementById('btn-change-username');
      var panel = document.getElementById('change-username-panel');
      var save = document.getElementById('btn-save-new-username');
      var input = document.getElementById('input-new-username');
      function eligible(){
        var last = info.last_username_change_at || 0;
        var firstDone = !!info.username_changed_once;
        if (!firstDone) return { allowed: true };
        var now = Date.now();
        var need = 30*24*60*60*1000;
        if (now - last >= need) return { allowed: true };
        var remain = Math.ceil((need - (now-last)) / (24*60*60*1000));
        return { allowed: false, remain: remain };
      }
      if (btn) btn.addEventListener('click', function(){
        var e = eligible();
        if (!e.allowed){ alert('暂不可修改，需等待约 ' + e.remain + ' 天'); return; }
        panel && panel.classList.remove('hidden');
        input && input.focus();
      });
      if (save) save.addEventListener('click', function(){
        var nv = (input ? input.value.trim() : '');
        if (!nv){ alert('请输入新用户名'); return; }
        if (nv === uname){ alert('新用户名不能与当前一致'); return; }
        if (nv.length < 2){ alert('用户名至少2个字符'); return; }
        var exists = !!reg[nv];
        if (exists){ alert('该用户名已被占用'); return; }
        var oldInfo = reg[uname]||{};
        var newInfo = Object.assign({}, oldInfo, { username_changed_once: true, last_username_change_at: Date.now() });
        reg[nv] = newInfo;
        delete reg[uname];
        setRegistry(reg);
        var pv = pts[uname]; if (typeof pv==='number'){ delete pts[uname]; pts[nv] = pv; setPoints(pts); }
        try { localStorage.setItem('yx_user', JSON.stringify({ username: nv, role: u.role, login_at: u.login_at })); } catch(e){}
        initUserCenter();
        alert('用户名已修改为：' + nv);
      });
    }

    function getInviteCfg(){
      var perSignup = 0; var perLogin = 0;
      try { var v = parseInt(localStorage.getItem('invite_points_per_signup')); if (!isNaN(v)) perSignup = v; } catch(e){}
      try { var v2 = parseInt(localStorage.getItem('invite_points_per_login')); if (!isNaN(v2)) perLogin = v2; } catch(e){}
      if (!perSignup) perSignup = 50;
      return { perSignup: perSignup, perLogin: perLogin };
    }

    function generateInviteCodeUnique(reg){
      function gen(){ return 'YX' + Math.random().toString(36).slice(2,10).toUpperCase(); }
      var code = gen();
      var exists = Object.keys(reg).some(function(k){ var v = reg[k]; return v && v.my_invite === code; });
      while (exists){ code = gen(); exists = Object.keys(reg).some(function(k){ var v = reg[k]; return v && v.my_invite === code; }); }
      return code;
    }

    function updateInviteCard(info, reg){
      var invDisp = document.getElementById('invite-code-display');
      var invLink = document.getElementById('invite-link-display');
      var btnGen = document.getElementById('btn-generate-invite');
      var countEl = document.getElementById('invite-count');
      var earnedEl = document.getElementById('invite-earned');
      var perSignupEl = document.getElementById('invite-per-signup');
      var cfg = getInviteCfg();
      if (perSignupEl) perSignupEl.textContent = String(cfg.perSignup);
      var myCode = info.my_invite || '';
      if (invDisp) invDisp.textContent = myCode || '尚未生成';
      if (invLink) invLink.value = myCode ? ((location.origin || '') + '/pages/user/login.html?invite=' + encodeURIComponent(myCode)) : '';
      if (btnGen){ btnGen.style.display = myCode ? 'none' : 'inline-block'; btnGen.onclick = function(){ var code = generateInviteCodeUnique(reg); info.my_invite = code; var u = JSON.parse(localStorage.getItem('yx_user')||'{}'); var uname = u.username; reg[uname] = info; setRegistry(reg); updateInviteCard(info, reg); alert('邀请码已生成：' + code); }; }
      var c = 0; if (myCode){ Object.keys(reg).forEach(function(k){ var v = reg[k]; if (v && v.invite === myCode) c++; }); }
      if (countEl) countEl.textContent = String(c);
      if (earnedEl) earnedEl.textContent = String(c * cfg.perSignup) + ' 分';
    }
    function updateMuseumSection(info, uname, reg, pts){
      var owned = getOwnedCardsUrls();
      var ownedNames = normalizeCardNames(owned);
      getMuseumGroups().then(function(groups){
        var progress = document.getElementById('mycards-progress');
        var grid = document.getElementById('mycards-grid');
        var empty = document.getElementById('mycards-empty');
        if (grid){ grid.innerHTML = owned.map(function(url){ return '<div class="border rounded overflow-hidden"><img src="' + url + '" class="w-full h-32 object-cover" /></div>'; }).join(''); }
        if (owned.length){ if (empty) empty.style.display='none'; } else { if (empty) empty.style.display=''; }
        var totalGroups = Array.isArray(groups) ? groups.length : 0;
        var completedGroups = 0;
        groups.forEach(function(g){ var need = Array.isArray(g.images) ? g.images : []; var done = need.length && need.every(function(n){ return ownedNames.indexOf(n) >= 0; }); if (done) completedGroups++; });
        if (progress){ progress.textContent = '分组：' + completedGroups + ' / ' + totalGroups + ' 已集齐'; }
        awardCompletedGroups(uname, groups, ownedNames, pts);
        renderPointsDetails(uname);
      }).catch(function(){ renderPointsDetails(uname); });
    }

    function getOwnedCardsUrls(){ var list=[]; try { list = JSON.parse(localStorage.getItem('jika_owned_cards')||'[]'); } catch(e){} if (!Array.isArray(list) || list.length===0){ try { list = JSON.parse(localStorage.getItem('owned_cards')||'[]'); } catch(e){} } if (!Array.isArray(list) || list.length===0){ try { list = JSON.parse(localStorage.getItem('user_avatar_cards')||'[]'); } catch(e){} } return Array.isArray(list) ? list : []; }
    function normalizeCardNames(arr){ return (arr||[]).map(function(u){ try { var url = new URL(u, location.origin); var seg = url.pathname.split('/').pop(); return decodeURIComponent(seg); } catch(e){ var s = (u||'').split('/').pop(); try { return decodeURIComponent(s); } catch(err){ return s; } } }); }
    function getInviteCfg(){ var perSignup = 0; var perLogin = 0; try { var v = parseInt(localStorage.getItem('invite_points_per_signup')); if (!isNaN(v)) perSignup = v; } catch(e){} try { var v2 = parseInt(localStorage.getItem('invite_points_per_login')); if (!isNaN(v2)) perLogin = v2; } catch(e){} if (!perSignup) perSignup = 50; return { perSignup: perSignup, perLogin: perLogin }; }
    function generateInviteCodeUnique(reg){ function gen(){ return 'YX' + Math.random().toString(36).slice(2,10).toUpperCase(); } var code = gen(); var exists = Object.keys(reg).some(function(k){ var v = reg[k]; return v && v.my_invite === code; }); while (exists){ code = gen(); exists = Object.keys(reg).some(function(k){ var v = reg[k]; return v && v.my_invite === code; }); } return code; }
    function getMuseumGroups(){ return new Promise(function(resolve){ var stored=[]; try { stored = JSON.parse(localStorage.getItem('museum_groups')||'[]'); } catch(e){} if (Array.isArray(stored) && stored.length){ resolve(stored); return; } fetch('/卡片/').then(function(res){ return res.text(); }).then(function(html){ var doc = new DOMParser().parseFromString(html, 'text/html'); var hrefs = Array.from(doc.querySelectorAll('a')).map(function(a){ return a.getAttribute('href'); }).filter(function(h){ return h && h.endsWith('.png'); }); var files = hrefs.map(function(h){ return decodeURIComponent(h); }); var groups = randomPartition(shuffle(files.slice()), 4).map(function(images, idx){ return { id: 'g'+(idx+1), name: '第'+(idx+1)+'组', images: images }; }); localStorage.setItem('museum_groups', JSON.stringify(groups)); resolve(groups); }).catch(function(){ resolve([]); }); }); }
    function shuffle(arr){ for (var i=arr.length-1;i>0;i--){ var j = Math.floor(Math.random()*(i+1)); var t = arr[i]; arr[i]=arr[j]; arr[j]=t; } return arr; }
    function randomPartition(files, k){ var n=files.length; if (!n){ return Array.from({length:k}, function(){ return []; }); } var cuts = new Set(); while (cuts.size < k-1){ var p = Math.floor(Math.random()*(n-1))+1; cuts.add(p); } var points = Array.from(cuts).sort(function(a,b){ return a-b; }); var groups=[]; var prev=0; points.forEach(function(c){ groups.push(files.slice(prev,c)); prev=c; }); groups.push(files.slice(prev)); return groups; }
    function awardCompletedGroups(uname, groups, ownedNames, pts){ var reward = parseInt(localStorage.getItem('card_group_points_reward')); if (isNaN(reward) || reward<=0) reward = 100; var map={}; try { map = JSON.parse(localStorage.getItem('card_group_rewards')||'{}'); } catch(e){} var userMap = map[uname] || {}; var did = false; (groups||[]).forEach(function(g){ var need = Array.isArray(g.images) ? g.images : []; var done = need.length && need.every(function(n){ return ownedNames.indexOf(n) >= 0; }); if (done && !userMap[g.id]){ var cur = typeof pts[uname]==='number' ? pts[uname] : 0; pts[uname] = cur + reward; setPoints(pts); userMap[g.id] = { at: Date.now(), points: reward }; did = true; } }); map[uname] = userMap; localStorage.setItem('card_group_rewards', JSON.stringify(map)); if (did){ var elPts = document.getElementById('profile-points'); if (elPts){ var p = pts[uname]; elPts.textContent = String(p) + ' 分'; } }
    }
    function getPointsGainHistory(){ try { return JSON.parse(localStorage.getItem('points_gain_history')||'{}'); } catch(e){ return {}; } }
    function setPointsGainHistory(obj){ try { localStorage.setItem('points_gain_history', JSON.stringify(obj)); } catch(e){} }
    function renderPointsDetails(uname){ var map = getPointsGainHistory(); var list = Array.isArray(map[uname]) ? map[uname] : []; var empty = document.getElementById('points-empty'); var tbody = document.getElementById('points-tbody'); if (tbody){ tbody.innerHTML = list.map(function(r, idx){ var tm = fmtDate(r.at||Date.now()); var ch = r.channel||''; var pts = r.points||0; var note = r.note||''; return '<tr><td class="py-2 px-4 border-b">' + tm + '</td><td class="py-2 px-4 border-b">' + ch + '</td><td class="py-2 px-4 border-b">' + pts + '</td><td class="py-2 px-4 border-b">' + note + '</td><td class="py-2 px-4 border-b"><button class="btn-secondary btn-sm points-del" data-idx="' + idx + '">删除</button></td></tr>'; }).join(''); var ds = tbody.querySelectorAll('button.points-del'); ds.forEach(function(b){ b.addEventListener('click', function(){ var i = parseInt(b.getAttribute('data-idx')); if (isNaN(i)) return; var map2 = getPointsGainHistory(); var l = Array.isArray(map2[uname]) ? map2[uname] : []; l.splice(i, 1); map2[uname] = l; setPointsGainHistory(map2); renderPointsDetails(uname); }); }); } if (empty){ empty.style.display = list.length ? 'none' : ''; } var elTP = document.getElementById('my-total-points'); if (elTP){ var ptsMap = getPoints(); var p = ptsMap[uname]; if (typeof p!=='number') p = 0; elTP.textContent = String(p) + ' 分'; }
    }
    function getNotices(){ try { return JSON.parse(localStorage.getItem('yx_notices')||'{}'); } catch(e){ return {}; } }
    function setNotices(obj){ try { localStorage.setItem('yx_notices', JSON.stringify(obj)); } catch(e){} }
    function renderNotices(uname){ var map = getNotices(); var list = Array.isArray(map[uname]) ? map[uname] : []; var empty = document.getElementById('notices-empty'); var tbody = document.getElementById('notices-tbody'); var countEl = document.getElementById('notice-unread-count'); if (countEl) countEl.textContent = String(list.filter(function(n){ return !n.read; }).length); if (tbody){ tbody.innerHTML = list.map(function(n, idx){ var st = n.read ? '已读' : '未读'; var tm = fmtDate(n.at || Date.now()); return '<tr><td class="py-2 px-4 border-b">' + (n.title||'') + '</td><td class="py-2 px-4 border-b">' + tm + '</td><td class="py-2 px-4 border-b">' + st + '</td><td class="py-2 px-4 border-b"><button class="btn-secondary btn-sm notice-read" data-idx="' + idx + '">阅读</button> <button class="btn-accent btn-sm notice-delete" data-idx="' + idx + '">删除</button></td></tr>'; }).join(''); var rs = tbody.querySelectorAll('button.notice-read'); rs.forEach(function(b){ b.addEventListener('click', function(){ var i = parseInt(b.getAttribute('data-idx')); if (isNaN(i)) return; var map2 = getNotices(); var l = Array.isArray(map2[uname]) ? map2[uname] : []; var it = l[i]; if (!it) return; it.read = true; map2[uname] = l; setNotices(map2); renderNotices(uname); }); }); var ds = tbody.querySelectorAll('button.notice-delete'); ds.forEach(function(b){ b.addEventListener('click', function(){ var i = parseInt(b.getAttribute('data-idx')); if (isNaN(i)) return; var map2 = getNotices(); var l = Array.isArray(map2[uname]) ? map2[uname] : []; l.splice(i, 1); map2[uname] = l; setNotices(map2); renderNotices(uname); }); }); } if (empty){ empty.style.display = list.length ? 'none' : ''; }
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>报价配置管理 - AI智货代</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/global.css">
</head>
<body class="bg-gray-50 font-sans text-dark">
  <!-- 统一头部组件 -->
  <div id="header-container"></div>
  <main class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-semibold text-gray-800">报价配置管理</h1>
        <a href="/pages/admin/index.html" class="text-primary hover:underline"><i class="fas fa-arrow-left mr-2"></i>返回仪表盘</a>
      </div>
      <p class="text-gray-600 mb-4">配置公司信息、水印显示、销售与报价、以及前台报价交互；保存后写入 localStorage，前台 /pages/pricing/index.html 自动联动。</p>

      <!-- 公司与水印配置 -->
      <section class="p-4 border rounded-lg mb-6">
        <h2 class="font-semibold mb-2 flex items-center"><i class="fas fa-building mr-2 text-blue-600"></i>公司与水印</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-gray-700">公司名称（显示在水印与报价弹窗顶部）</span>
            <input id="companyName" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：YXTrans" />
          </label>
          <label class="block">
            <span class="text-sm text-gray-700">公司域名（显示在水印）</span>
            <input id="companyDomain" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：yxtrans.cn" />
          </label>
        </div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-gray-700">开发模式水印开关</span>
            <select id="wmDevOverride" class="mt-1 w-full border rounded px-3 py-2">
              <option value="">跟随会员逻辑（默认）</option>
              <option value="on">强制显示</option>
              <option value="off">强制隐藏</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm text-gray-700">是否付费会员（影响水印显示）</span>
            <select id="isPaidMember" class="mt-1 w-full border rounded px-3 py-2">
              <option value="false">否（显示水印）</option>
              <option value="true">是（隐藏水印）</option>
            </select>
          </label>
        </div>
        <div class="mt-3 flex gap-3">
          <button id="saveCompany" class="bg-primary text-white px-4 py-2 rounded"><i class="fas fa-save mr-2"></i>保存公司与水印配置</button>
          <button id="openPricing" class="bg-gray-200 text-gray-800 px-4 py-2 rounded"><i class="fas fa-eye mr-2"></i>打开前台报价页预览</button>
        </div>
      </section>

      <!-- 销售与报价信息 -->
      <section class="p-4 border rounded-lg mb-6">
        <h2 class="font-semibold mb-2 flex items-center"><i class="fas fa-user-tie mr-2 text-green-600"></i>销售与报价信息</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="block">
            <span class="text-sm text-gray-700">销售人员姓名</span>
            <input id="salesName" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：王敏" />
          </label>
          <label class="block">
            <span class="text-sm text-gray-700">销售联系方式（手机号或微信）</span>
            <input id="salesContact" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：13800001234 / wangmin" />
          </label>
          <label class="block">
            <span class="text-sm text-gray-700">报价编号（自动增长或手工）</span>
            <input id="quoteNumber" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：Q2025-0001" />
          </label>
        </div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="block">
            <span class="text-sm text-gray-700">预计交付时间（天）</span>
            <input id="estimateDays" type="number" min="1" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：3" />
          </label>
          <label class="block">
            <span class="text-sm text-gray-700">地面费（Ground Fee，USD）</span>
            <input id="groundFeeUSD" type="number" step="0.01" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：25" />
          </label>
          <label class="block">
            <span class="text-sm text-gray-700">地面费（RMB）</span>
            <input id="groundFeeRMB" type="number" step="0.01" class="mt-1 w-full border rounded px-3 py-2" placeholder="如：180" />
          </label>
        </div>
        <div class="mt-3">
          <button id="saveSales" class="bg-primary text-white px-4 py-2 rounded"><i class="fas fa-save mr-2"></i>保存销售与报价信息</button>
        </div>
      </section>

      <!-- 前台报价交互 -->
      <section class="p-4 border rounded-lg mb-6">
        <h2 class="font-semibold mb-2 flex items-center"><i class="fas fa-exchange-alt mr-2 text-purple-600"></i>前台报价交互</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-gray-700">默认币种</span>
            <select id="defaultCurrency" class="mt-1 w-full border rounded px-3 py-2">
              <option value="USD">USD</option>
              <option value="RMB">RMB</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm text-gray-700">是否显示币种切换</span>
            <select id="showCurrencyToggle" class="mt-1 w-full border rounded px-3 py-2">
              <option value="true">显示</option>
              <option value="false">隐藏</option>
            </select>
          </label>
        </div>
        <div class="mt-3">
          <button id="saveInteraction" class="bg-primary text-white px-4 py-2 rounded"><i class="fas fa-save mr-2"></i>保存交互配置</button>
        </div>
      </section>

      <!-- 运价数据集管理（Excel/CSV 导入 + 编辑/删除/批量操作） -->
      <section class="p-4 border rounded-lg mb-6">
        <h2 class="font-semibold mb-2 flex items-center"><i class="fas fa-table mr-2 text-indigo-600"></i>运价数据集管理</h2>
        <p class="text-gray-600 text-sm mb-3">支持从 Excel 转为 CSV 导入；字段：序号、起运港、目的港、20GP、40GP/HQ、船东、船期、备注。保存后写入 localStorage（键：<code>freight_quotes_db</code>），前台定价页读取。</p>
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <label class="btn-secondary cursor-pointer"><i class="fas fa-file-csv mr-2"></i>导入CSV文件
            <input type="file" id="quotes-csv-file" accept=".csv" class="hidden">
          </label>
          <button type="button" id="quotes-export-csv" class="btn-secondary"><i class="fas fa-download mr-2"></i>导出CSV</button>
          <button type="button" id="quotes-add-row" class="btn-secondary"><i class="fas fa-plus mr-2"></i>新增一条</button>
          <button type="button" id="quotes-batch-delete" class="btn-secondary"><i class="fas fa-trash mr-2"></i>批量删除所选</button>
          <button type="button" id="quotes-clear" class="btn-secondary"><i class="fas fa-ban mr-2"></i>清空全部</button>
          <a href="/data/pricing/freight_quotes_template.csv" download class="btn-secondary"><i class="fas fa-file-download mr-2"></i>下载模板</a>
          <a href="/data/pricing/freight_quotes_sample.csv" download class="btn-secondary"><i class="fas fa-file-download mr-2"></i>下载示例</a>
          <button type="button" id="quotes-load-template" class="btn-secondary"><i class="fas fa-file-import mr-2"></i>从项目模板加载</button>
          <button type="button" id="quotes-load-sample" class="btn-secondary"><i class="fas fa-file-import mr-2"></i>从项目示例加载</button>
        </div>
        <table class="w-full text-sm border mb-3" id="quotes-admin-table">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2 border w-10"><input type="checkbox" id="quotes-check-all"></th>
              <th class="p-2 border">序号</th>
              <th class="p-2 border">起运港</th>
              <th class="p-2 border">目的港</th>
              <th class="p-2 border">20GP</th>
              <th class="p-2 border">40GP/HQ</th>
              <th class="p-2 border">船东</th>
              <th class="p-2 border">船期</th>
              <th class="p-2 border">备注</th>
              <th class="p-2 border">操作</th>
            </tr>
          </thead>
          <tbody id="quotes-admin-tbody"></tbody>
        </table>
        <div class="text-xs text-gray-600">CSV表头支持中英文与大小写：index|序号, origin|起运港, destination|目的港, rate20gp|20gp, rate40gp|40gp/40hq, carrier|船东, sailing|船期|开船日, remark|备注</div>
      </section>

      <!-- 人民币费用明细（多港口）管理 -->
      <section class="p-4 border rounded-lg mb-6">
        <h2 class="font-semibold mb-2 flex items-center"><i class="fas fa-yen-sign mr-2 text-red-600"></i>人民币费用明细（多港口）</h2>
        <p class="text-gray-600 text-sm mb-3">支持按港口维护费用项（THC、DOC、ORC、封签费、提单费等），CSV导入/导出。保存后写入 localStorage（键：<code>fees_rmb_db</code>），前台可用于报价计算。</p>
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <label class="btn-secondary cursor-pointer"><i class="fas fa-file-csv mr-2"></i>导入CSV文件
            <input type="file" id="fees-csv-file" accept=".csv" class="hidden">
          </label>
          <button type="button" id="fees-export-csv" class="btn-secondary"><i class="fas fa-download mr-2"></i>导出CSV</button>
          <button type="button" id="fees-add-row" class="btn-secondary"><i class="fas fa-plus mr-2"></i>新增一条</button>
          <button type="button" id="fees-batch-delete" class="btn-secondary"><i class="fas fa-trash mr-2"></i>批量删除所选</button>
          <button type="button" id="fees-clear" class="btn-secondary"><i class="fas fa-ban mr-2"></i>清空全部</button>
          <a href="/data/pricing/fees_rmb_template.csv" download class="btn-secondary"><i class="fas fa-file-download mr-2"></i>下载模板</a>
          <a href="/data/pricing/fees_rmb_sample.csv" download class="btn-secondary"><i class="fas fa-file-download mr-2"></i>下载示例</a>
          <button type="button" id="fees-load-template" class="btn-secondary"><i class="fas fa-file-import mr-2"></i>从项目模板加载</button>
          <button type="button" id="fees-load-sample" class="btn-secondary"><i class="fas fa-file-import mr-2"></i>从项目示例加载</button>
        </div>
        <table class="w-full text-sm border mb-3" id="fees-admin-table">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2 border w-10"><input type="checkbox" id="fees-check-all"></th>
              <th class="p-2 border">序号</th>
              <th class="p-2 border">港口</th>
              <th class="p-2 border">费用名称</th>
              <th class="p-2 border">金额(RMB)</th>
              <th class="p-2 border">适用范围</th>
              <th class="p-2 border">备注</th>
              <th class="p-2 border">操作</th>
            </tr>
          </thead>
          <tbody id="fees-admin-tbody"></tbody>
        </table>
        <div class="text-xs text-gray-600">CSV表头支持中英文与大小写：port|港口|port_name, fee_name|费用名称, amount_rmb|金额rmb, scope|适用范围, remark|备注</div>
      </section>

      <div class="rounded bg-blue-50 border border-blue-200 p-3 text-sm text-blue-700">说明：以上配置均写入浏览器 localStorage，被前台 /pages/pricing/index.html 读取并即时生效；用于快速联调与演示。后续可替换为后端接口存储。</div>
    </div>
  </main>
  <div id="footer-container"></div>
  <script src="/assets/js/global.js?v=20251114"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (typeof loadComponent === 'function') {
        loadComponent('header-container', '../../components/header.html');
        loadComponent('footer-container', '/components/footer.html');
      }
    });
  </script>
  <script>
    // 从 localStorage 读取现有值并回填
    function initForm() {
      const get = (k, d='') => localStorage.getItem(k) ?? d;
      document.getElementById('companyName').value = get('member_company_name');
      document.getElementById('companyDomain').value = get('member_company_domain');
      document.getElementById('wmDevOverride').value = get('wm_dev_override');
      document.getElementById('isPaidMember').value = get('is_paid_member') ?? 'false';

      document.getElementById('salesName').value = get('sales_name');
      document.getElementById('salesContact').value = get('sales_contact');
      document.getElementById('quoteNumber').value = get('quote_number');
      document.getElementById('estimateDays').value = get('estimate_days');
      document.getElementById('groundFeeUSD').value = get('ground_fee_usd');
      document.getElementById('groundFeeRMB').value = get('ground_fee_rmb');

      document.getElementById('defaultCurrency').value = get('default_currency','USD');
      document.getElementById('showCurrencyToggle').value = get('show_currency_toggle','true');
    }

    function saveCompany() {
      const name = document.getElementById('companyName').value.trim();
      const domain = document.getElementById('companyDomain').value.trim();
      const wm = document.getElementById('wmDevOverride').value;
      const paid = document.getElementById('isPaidMember').value;
      localStorage.setItem('member_company_name', name);
      localStorage.setItem('member_company_domain', domain);
      if (wm) { localStorage.setItem('wm_dev_override', wm); } else { localStorage.removeItem('wm_dev_override'); }
      localStorage.setItem('is_paid_member', paid);
      alert('公司与水印配置已保存');
    }

    function saveSales() {
      const set = (k, v) => localStorage.setItem(k, v);
      set('sales_name', document.getElementById('salesName').value.trim());
      set('sales_contact', document.getElementById('salesContact').value.trim());
      set('quote_number', document.getElementById('quoteNumber').value.trim());
      set('estimate_days', document.getElementById('estimateDays').value.trim());
      set('ground_fee_usd', document.getElementById('groundFeeUSD').value.trim());
      set('ground_fee_rmb', document.getElementById('groundFeeRMB').value.trim());
      alert('销售与报价信息已保存');
    }

    function saveInteraction() {
      localStorage.setItem('default_currency', document.getElementById('defaultCurrency').value);
      localStorage.setItem('show_currency_toggle', document.getElementById('showCurrencyToggle').value);
      alert('交互配置已保存');
    }

    function openPricing() {
      window.open('/pages/pricing/index.html', '_blank');
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('saveCompany').addEventListener('click', saveCompany);
      document.getElementById('openPricing').addEventListener('click', openPricing);
      document.getElementById('saveSales').addEventListener('click', saveSales);
      document.getElementById('saveInteraction').addEventListener('click', saveInteraction);
      initForm();
      // 初始化运价数据集管理
      initQuotesAdmin();
      // 初始化人民币费用管理
      initFeesAdmin();
    });
  </script>
  <script>
    // 运价数据集管理
    const QUOTES_KEY = 'freight_quotes_db';
    function getQuotes(){ try { return JSON.parse(localStorage.getItem(QUOTES_KEY)||'[]'); } catch { return []; } }
    function setQuotes(arr){ localStorage.setItem(QUOTES_KEY, JSON.stringify(arr)); }
    function renderQuotesAdmin(){
      const tbody = document.getElementById('quotes-admin-tbody'); if (!tbody) return;
      const quotes = getQuotes();
      tbody.innerHTML = '';
      quotes.forEach((q, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border text-center"><input type="checkbox" data-idx="${idx}" class="quotes-row-check"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${q.index||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${q.origin||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${q.destination||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${q.rate20gp||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${(q.rate40hq ?? q.rate40gp) || ''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${q.carrier||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${q.sailing||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${q.remark||''}"></td>
          <td class="p-2 border">
            <button class="btn-secondary text-xs mr-2" data-act="save" data-idx="${idx}"><i class="fas fa-save mr-1"></i>保存</button>
            <button class="btn-secondary text-xs" data-act="delete" data-idx="${idx}"><i class="fas fa-trash mr-1"></i>删除</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function initQuotesAdmin(){
      const inputFile = document.getElementById('quotes-csv-file');
      const btnExport = document.getElementById('quotes-export-csv');
      const btnAdd = document.getElementById('quotes-add-row');
      const btnBatchDelete = document.getElementById('quotes-batch-delete');
      const btnClear = document.getElementById('quotes-clear');
      const tbl = document.getElementById('quotes-admin-table');
      const checkAll = document.getElementById('quotes-check-all');
      const btnLoadTpl = document.getElementById('quotes-load-template');
      const btnLoadSample = document.getElementById('quotes-load-sample');
      if (!inputFile || !btnExport || !btnAdd || !btnBatchDelete || !btnClear || !tbl || !checkAll) return;

      inputFile.addEventListener('change', function(){
        const file = this.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(){
          const text = reader.result.toString();
          const items = parseQuotesCSV(text);
          if (!items.length){ alert('CSV未解析到有效行'); return; }
          const arr = getQuotes(); items.forEach(it => arr.push(it)); setQuotes(arr); renderQuotesAdmin();
          alert(`已导入 ${items.length} 条运价`);
        };
        reader.readAsText(file, 'utf-8');
      });

      btnExport.addEventListener('click', function(){
        const quotes = getQuotes();
        const header = ['序号','起运港','目的港','20GP','40GP/HQ','船东','船期','备注'];
        const lines = [header.join(',')];
        quotes.forEach(q => {
          const row = [q.index||'', q.origin||'', q.destination||'', q.rate20gp||'', (q.rate40hq ?? q.rate40gp) || '', q.carrier||'', q.sailing||'', q.remark||''];
          lines.push(row.map(v => (v||'').toString().replace(/\n/g,' ').replace(/,/g,' ')).join(','));
        });
        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'freight_quotes_export.csv'; a.click(); URL.revokeObjectURL(url);
      });

      btnAdd.addEventListener('click', function(){
        const arr = getQuotes();
        arr.push({ index: String(arr.length+1), origin:'', destination:'', rate20gp:'', rate40gp:'', carrier:'', sailing:'', remark:'' });
        setQuotes(arr); renderQuotesAdmin();
      });

      btnBatchDelete.addEventListener('click', function(){
        const checks = Array.from(document.querySelectorAll('.quotes-row-check'));
        const idxs = checks.filter(c=>c.checked).map(c=>parseInt(c.getAttribute('data-idx'),10));
        if (!idxs.length){ alert('请先勾选要删除的行'); return; }
        if (!confirm(`确认删除 ${idxs.length} 条？`)) return;
        const arr = getQuotes().filter((_,i)=>!idxs.includes(i)); setQuotes(arr); renderQuotesAdmin();
      });

      btnClear.addEventListener('click', function(){
        if (!confirm('确认清空全部运价数据？')) return; setQuotes([]); renderQuotesAdmin();
      });

      checkAll.addEventListener('change', function(){
        const checks = document.querySelectorAll('.quotes-row-check'); checks.forEach(c=>c.checked = checkAll.checked);
      });

      async function loadQuotesFromPath(url){
        try {
          const res = await fetch(url);
          if (!res.ok){ alert('无法加载项目文件：'+url); return; }
          const text = await res.text();
          const items = parseQuotesCSV(text);
          if (!items.length){ alert('模板文件无数据或仅表头'); return; }
          const arr = getQuotes(); items.forEach(it => arr.push(it)); setQuotes(arr); renderQuotesAdmin();
          alert(`已从项目文件导入 ${items.length} 条运价`);
        } catch (e){ alert('加载失败：'+ e.message); }
      }

      if (btnLoadTpl) btnLoadTpl.addEventListener('click', ()=>loadQuotesFromPath('/data/pricing/freight_quotes_template.csv'));
      if (btnLoadSample) btnLoadSample.addEventListener('click', ()=>loadQuotesFromPath('/data/pricing/freight_quotes_sample.csv'));

      document.getElementById('quotes-admin-tbody').addEventListener('click', function(e){
        const btn = e.target.closest('button'); if (!btn) return;
        const act = btn.getAttribute('data-act'); const idx = parseInt(btn.getAttribute('data-idx'), 10);
        const tr = btn.closest('tr'); const inputs = tr.querySelectorAll('input');
        const rec = {
          index: inputs[1].value.trim(),
          origin: inputs[2].value.trim(),
          destination: inputs[3].value.trim(),
          rate20gp: inputs[4].value.trim(),
          rate40gp: inputs[5].value.trim(),
          carrier: inputs[6].value.trim(),
          sailing: inputs[7].value.trim(),
          remark: inputs[8].value.trim()
        };
        const arr = getQuotes();
        if (act==='save'){ arr[idx]=rec; setQuotes(arr); alert('已保存'); }
        else if (act==='delete'){ arr.splice(idx,1); setQuotes(arr); renderQuotesAdmin(); }
      });

      renderQuotesAdmin();
    }

    function parseQuotesCSV(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const rows = lines.map(line => line.split(',').map(s=>s.replace(/^"|"$/g,'').trim()));
      if (!rows.length) return [];
      const header = (rows[0]||[]).map(s=>s.toLowerCase());
      const isHeader = header.some(h=>['index','序号','origin','起运港','destination','目的港','20gp','rate20gp','40gp','40hq','rate40gp','船东','carrier','船期','sailing','remark','备注'].includes(h));
      const dataRows = isHeader ? rows.slice(1) : rows;
      function get(col){ return (h)=>{ const i = header.indexOf(col); return i>=0 ? h[i]||'' : ''; } }
      return dataRows.map(cols => {
        const h = cols;
        const map = (names)=>{ for (const n of names){ const i = header.indexOf(n); if (i>=0) return h[i]||''; } return ''; };
        return {
          index: map(['index','序号']),
          origin: map(['origin','起运港']),
          destination: map(['destination','目的港']),
          rate20gp: map(['rate20gp','20gp','20']),
          rate40gp: map(['rate40gp','40gp','40hq','40']),
          carrier: map(['carrier','船东']),
          sailing: map(['sailing','船期','开船日']),
          remark: map(['remark','备注'])
        };
      }).filter(r=>r.origin||r.destination||r.rate20gp||r.rate40gp||r.carrier||r.sailing||r.remark);
    }
  </script>
  <script>
    // 人民币费用明细（多港口）管理
    const FEES_KEY = 'fees_rmb_db';
    function getFees(){ try { return JSON.parse(localStorage.getItem(FEES_KEY)||'[]'); } catch { return []; } }
    function setFees(arr){ localStorage.setItem(FEES_KEY, JSON.stringify(arr)); }
    function renderFeesAdmin(){
      const tbody = document.getElementById('fees-admin-tbody'); if (!tbody) return;
      const fees = getFees();
      tbody.innerHTML = '';
      fees.forEach((f, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border text-center"><input type="checkbox" data-idx="${idx}" class="fees-row-check"></td>
          <td class="p-2 border">${idx+1}</td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${f.port||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${f.fee_name||''}"></td>
          <td class="p-2 border"><input type="number" step="0.01" class="border rounded px-2 py-1 w-full" value="${f.amount_rmb||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${f.scope||''}"></td>
          <td class="p-2 border"><input class="border rounded px-2 py-1 w-full" value="${f.remark||''}"></td>
          <td class="p-2 border">
            <button class="btn-secondary text-xs mr-2" data-act="save" data-idx="${idx}"><i class="fas fa-save mr-1"></i>保存</button>
            <button class="btn-secondary text-xs" data-act="delete" data-idx="${idx}"><i class="fas fa-trash mr-1"></i>删除</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function initFeesAdmin(){
      const inputFile = document.getElementById('fees-csv-file');
      const btnExport = document.getElementById('fees-export-csv');
      const btnAdd = document.getElementById('fees-add-row');
      const btnBatchDelete = document.getElementById('fees-batch-delete');
      const btnClear = document.getElementById('fees-clear');
      const tbl = document.getElementById('fees-admin-table');
      const checkAll = document.getElementById('fees-check-all');
      const btnLoadTpl = document.getElementById('fees-load-template');
      const btnLoadSample = document.getElementById('fees-load-sample');
      if (!inputFile || !btnExport || !btnAdd || !btnBatchDelete || !btnClear || !tbl || !checkAll) return;

      inputFile.addEventListener('change', function(){
        const file = this.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(){
          const text = reader.result.toString();
          const items = parseFeesCSV(text);
          if (!items.length){ alert('CSV未解析到有效行'); return; }
          const arr = getFees(); items.forEach(it => arr.push(it)); setFees(arr); renderFeesAdmin();
          alert(`已导入 ${items.length} 条费用`);
        };
        reader.readAsText(file, 'utf-8');
      });

      btnExport.addEventListener('click', function(){
        const fees = getFees();
        const header = ['港口','费用名称','金额RMB','适用范围','备注'];
        const lines = [header.join(',')];
        fees.forEach(f => {
          const row = [f.port||'', f.fee_name||'', f.amount_rmb||'', f.scope||'', f.remark||''];
          lines.push(row.map(v => (v||'').toString().replace(/\n/g,' ').replace(/,/g,' ')).join(','));
        });
        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'fees_rmb_export.csv'; a.click(); URL.revokeObjectURL(url);
      });

      btnAdd.addEventListener('click', function(){
        const arr = getFees();
        arr.push({ port:'', fee_name:'', amount_rmb:'', scope:'', remark:'' });
        setFees(arr); renderFeesAdmin();
      });

      btnBatchDelete.addEventListener('click', function(){
        const checks = Array.from(document.querySelectorAll('.fees-row-check'));
        const idxs = checks.filter(c=>c.checked).map(c=>parseInt(c.getAttribute('data-idx'),10));
        if (!idxs.length){ alert('请先勾选要删除的行'); return; }
        if (!confirm(`确认删除 ${idxs.length} 条？`)) return;
        const arr = getFees().filter((_,i)=>!idxs.includes(i)); setFees(arr); renderFeesAdmin();
      });

      btnClear.addEventListener('click', function(){
        if (!confirm('确认清空全部费用数据？')) return; setFees([]); renderFeesAdmin();
      });

      checkAll.addEventListener('change', function(){
        const checks = document.querySelectorAll('.fees-row-check'); checks.forEach(c=>c.checked = checkAll.checked);
      });

      async function loadFeesFromPath(url){
        try {
          const res = await fetch(url);
          if (!res.ok){ alert('无法加载项目文件：'+url); return; }
          const text = await res.text();
          const items = parseFeesCSV(text);
          if (!items.length){ alert('模板文件无数据或仅表头'); return; }
          const arr = getFees(); items.forEach(it => arr.push(it)); setFees(arr); renderFeesAdmin();
          alert(`已从项目文件导入 ${items.length} 条费用`);
        } catch (e){ alert('加载失败：'+ e.message); }
      }

      if (btnLoadTpl) btnLoadTpl.addEventListener('click', ()=>loadFeesFromPath('/data/pricing/fees_rmb_template.csv'));
      if (btnLoadSample) btnLoadSample.addEventListener('click', ()=>loadFeesFromPath('/data/pricing/fees_rmb_sample.csv'));

      document.getElementById('fees-admin-tbody').addEventListener('click', function(e){
        const btn = e.target.closest('button'); if (!btn) return;
        const act = btn.getAttribute('data-act'); const idx = parseInt(btn.getAttribute('data-idx'), 10);
        const tr = btn.closest('tr'); const inputs = tr.querySelectorAll('input');
        const rec = {
          port: inputs[2].value.trim(),
          fee_name: inputs[3].value.trim(),
          amount_rmb: inputs[4].value.trim(),
          scope: inputs[5].value.trim(),
          remark: inputs[6].value.trim()
        };
        const arr = getFees();
        if (act==='save'){ arr[idx]=rec; setFees(arr); alert('已保存'); }
        else if (act==='delete'){ arr.splice(idx,1); setFees(arr); renderFeesAdmin(); }
      });

      renderFeesAdmin();
    }

    function parseFeesCSV(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const rows = lines.map(line => line.split(',').map(s=>s.replace(/^"|"$/g,'').trim()));
      if (!rows.length) return [];
      const header = (rows[0]||[]).map(s=>s.toLowerCase());
      const isHeader = header.some(h=>['port','港口','port_name','fee_name','费用名称','amount_rmb','金额rmb','scope','适用范围','remark','备注'].includes(h));
      const dataRows = isHeader ? rows.slice(1) : rows;
      return dataRows.map(cols => {
        const h = cols;
        const map = (names)=>{ for (const n of names){ const i = header.indexOf(n); if (i>=0) return h[i]||''; } return ''; };
        return {
          port: map(['port','港口','port_name']),
          fee_name: map(['fee_name','费用名称']),
          amount_rmb: map(['amount_rmb','金额rmb','金额']),
          scope: map(['scope','适用范围']),
          remark: map(['remark','备注'])
        };
      }).filter(r=>r.port||r.fee_name||r.amount_rmb||r.scope||r.remark);
    }
  </script>
  <script>
    //（可选）权限校验：非管理员也可预览，若需限制可打开以下校验
    /* (function(){
      try {
        const u = JSON.parse(localStorage.getItem('yx_user'));
        if (!u || (u.role !== 'super_admin' && u.role !== 'admin')) {
          alert('该页面仅限管理员访问。');
          window.location.href = '/pages/user/login.html';
        }
      } catch (e) {
        window.location.href = '/pages/user/login.html';
      }
    })(); */
  </script>
</body>
</html>
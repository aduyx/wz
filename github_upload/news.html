<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>行业快讯 - AI智货代</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/global.css">
</head>
<body>
  <div id="header-container"></div>

  <main class="container mx-auto px-4 py-8">
    <!-- 顶部标题与返回 -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold">行业快讯</h1>
      <a href="index.html" class="text-primary hover:text-primary/80 font-medium transition-all duration-300 ease-in-out hover:underline">
        <i class="fas fa-arrow-left mr-2"></i>返回首页
      </a>
    </div>

    <!-- 两列布局：左 70% / 右 30% -->
    <div class="grid grid-cols-1 lg:grid-cols-10 gap-6">
      <!-- 左侧主内容区域 -->
      <section class="lg:col-span-7 space-y-6">
        <!-- 置顶通栏文章 + 搜索工具栏 -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-blue-500">
          <div class="md:flex">
            <div id="pin-cover" class="md:w-[70%] h-40 md:h-48 bg-gray-100 flex items-center justify-center">
              <i class="fas fa-newspaper text-gray-400 text-4xl"></i>
            </div>
            <div class="md:w-[30%] p-4">
              <h2 id="pin-title" class="text-xl font-semibold mb-2 line-clamp-2">置顶文章标题</h2>
              <p id="pin-summary" class="text-gray-600 mb-3 line-clamp-3">置顶文章摘要占位，后台维护或从 home_news 读取最新一条作为置顶。</p>
              <div class="flex items-center gap-3">
                <a id="pin-link" href="#" target="_self" class="inline-flex items-center text-primary hover:underline">
                  阅读全文<i class="fas fa-arrow-right ml-2"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="border-t border-blue-200 p-4 bg-gray-50">
            <div class="flex gap-2">
              <div class="relative flex-1">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input id="search-input" type="text" placeholder="搜索标题或摘要关键字" class="w-full pl-10 pr-3 py-2 border rounded-md focus:ring-2 focus:ring-primary/50">
              </div>
              <button id="search-clear" class="px-3 py-2 border rounded-md hover:bg-gray-100">清空搜索</button>
            </div>
          </div>
        </div>

        <!-- 最新文章（4） -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-blue-500">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">最新文章</h3>
          </div>
          <div id="grid-latest" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- 最热文章（4） -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-orange-500">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">最热文章</h3>
          </div>
          <div id="grid-hot" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <!-- 发布列表（时间排序，8，2行×4列） -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-green-500">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">发布列表</h3>
          </div>
          <div id="grid-timeline" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>
      </section>

      <!-- 右侧侧栏区域 -->
      <aside class="lg:col-span-3 space-y-6">
        <!-- 作者介绍 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-purple-500">
          <h3 class="text-lg font-semibold mb-3">作者介绍</h3>
          <div class="flex flex-col items-center text-center gap-2 mb-2">
            <img id="author-avatar" src="/assets/images/logo.webp" alt="作者头像" class="w-16 h-16 rounded-full object-cover">
            <div class="text-center">
              <div id="author-name" class="font-medium">AI智货代编辑部</div>
              <div id="author-bio" class="text-gray-600 text-sm">聚焦航运与货代行业趋势与干货分享。</div>
            </div>
          </div>
          <div>
            <h4 class="font-medium mb-2">特邀嘉宾</h4>
            <div id="guest-list" class="space-y-2"></div>
          </div>
        </div>

        <!-- 标签分类 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-yellow-500">
          <h3 class="text-lg font-semibold mb-3">标签分类</h3>
          <div id="tag-list" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- 热门文章列表 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-red-500">
          <h3 class="text-lg font-semibold mb-3">热门文章</h3>
          <ul id="hot-list" class="space-y-2"></ul>
        </div>
      </aside>
    </div>
  </main>

  <div id="footer-container"></div>

  <script src="/assets/js/global.js?v=20251114"></script>
  <script>
    // 加载页眉和页脚组件
    document.addEventListener('DOMContentLoaded', function() {
      loadComponent('header-container', '/components/header.html');
      loadComponent('footer-container', '/components/footer.html');
    });

    // ================== 数据源与工具函数 ==================
    const LS_NEWS_KEY = 'home_news';
    function readNews() {
      try {
        const arr = JSON.parse(localStorage.getItem(LS_NEWS_KEY) || '[]');
        if (!Array.isArray(arr) || arr.length === 0) return [];
        // 统一字段结构
        return arr.map((it, i) => ({
          id: it.id || String(i+1),
          title: it.title || '未命名文章',
          summary: it.summary || '',
          href: it.href || 'pages/news/detail.html',
          cover: it.cover || '',
          publishDate: it.publishDate || '',
          source: it.source || '',
          tags: Array.isArray(it.tags) ? it.tags : [],
          heat: typeof it.heat === 'number' ? it.heat : ((it.title||'').length + (it.summary||'').length)
        }));
      } catch (e) {
        return [];
      }
    }

    function isExternal(href){ return /^https?:\/\//.test(href||''); }
    function buildDetailLink(item) {
      const href = item.href || '';
      if (isExternal(href)) return { url: href, target: '_blank', rel: 'noopener' };
      // 内链：跳转到详情页并传递 id 或标题
      const url = href.includes('detail.html') ? `${href}?id=${encodeURIComponent(item.id)}` : href;
      return { url, target: '_self', rel: '' };
    }

    function createCard(item){
      const link = buildDetailLink(item);
      const a = document.createElement('a');
      a.href = link.url; a.target = link.target; if (link.rel) a.rel = link.rel;
      a.className = 'block rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow';
      const img = document.createElement('div');
      img.className = 'h-24 bg-gray-100 flex items-center justify-center';
      img.innerHTML = item.cover ? `<img src="${item.cover}" alt="${item.title}" class="w-full h-full object-cover">` : '<i class="fas fa-newspaper text-gray-400 text-2xl"></i>';
      const cont = document.createElement('div');
      cont.className = 'p-3';
      const h = document.createElement('h4'); h.className = 'font-semibold text-sm mb-1 line-clamp-2'; h.textContent = item.title;
      const p = document.createElement('p'); p.className = 'text-gray-600 text-xs line-clamp-2'; p.textContent = item.summary||'';
      cont.appendChild(h); cont.appendChild(p);
      a.appendChild(img); a.appendChild(cont);
      return a;
    }

    function renderGrid(containerId, items, maxCount){
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = '';
      items.slice(0, maxCount).forEach(item => el.appendChild(createCard(item)));
      if (items.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'col-span-2 md:col-span-4 text-gray-500 text-sm';
        empty.textContent = '暂无数据';
        el.appendChild(empty);
      }
    }

    function sortByDateDesc(arr){
      return [...arr].sort((a,b) => {
        const ta = a.publishDate ? Date.parse(a.publishDate) : 0;
        const tb = b.publishDate ? Date.parse(b.publishDate) : 0;
        return tb - ta;
      });
    }
    function sortByHeatDesc(arr){
      return [...arr].sort((a,b) => (b.heat||0) - (a.heat||0));
    }

    // ================== 右侧栏渲染（读取后台配置，带默认占位） ==================
    const defaultSideAuthor = { avatar: '/assets/images/logo.webp', name: 'AI智货代编辑部', bio: '聚焦航运与货代行业趋势与干货分享。' };
    const defaultSideGuests = [
      { avatar: '/assets/images/2msk.webp', name: '马士基资深顾问', intro: '解读航线与市场策略' },
      { avatar: '/assets/images/4cosco.webp', name: '中远海运分析师', intro: '货代数字化实践' },
      { avatar: '/assets/images/6one.webp', name: 'ONE运营经理', intro: '东南亚港口洞察' }
    ];
    const defaultSideTags = ['航线', '港口', '集装箱', '运价', '数字化', '供应链'];
    function readSideAuthor(){ try { return JSON.parse(localStorage.getItem('news_side_author') || 'null') || defaultSideAuthor; } catch { return defaultSideAuthor; } }
    function readSideGuests(){ try { const arr = JSON.parse(localStorage.getItem('news_side_guests') || '[]'); return Array.isArray(arr) && arr.length ? arr : defaultSideGuests; } catch { return defaultSideGuests; } }
    function readSideTags(){ try { const arr = JSON.parse(localStorage.getItem('news_side_tags') || '[]'); return Array.isArray(arr) && arr.length ? arr : defaultSideTags; } catch { return defaultSideTags; } }
    function renderSideAuthor(){
      const author = readSideAuthor();
      document.getElementById('author-avatar').src = author.avatar;
      document.getElementById('author-name').textContent = author.name;
      document.getElementById('author-bio').textContent = author.bio;
      const guestWrap = document.getElementById('guest-list'); guestWrap.innerHTML='';
      readSideGuests().forEach(g => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-3';
        row.innerHTML = `<img src="${g.avatar}" class="w-8 h-8 rounded-full object-cover" alt="${g.name}"><div class="text-sm"><div class="font-medium">${g.name}</div><div class="text-gray-600">${g.intro}</div></div>`;
        guestWrap.appendChild(row);
      });
    }
    function renderSideTags(onClick){
      const wrap = document.getElementById('tag-list'); wrap.innerHTML='';
      readSideTags().forEach(tag => {
        const b = document.createElement('button');
        b.className = 'px-3 py-1 border rounded-full text-sm hover:bg-gray-50';
        b.textContent = tag;
        b.addEventListener('click', () => onClick(tag));
        wrap.appendChild(b);
      });
    }
    function renderSideHotList(items){
      const ul = document.getElementById('hot-list'); ul.innerHTML='';
      items.slice(0,6).forEach(item => {
        const link = buildDetailLink(item);
        const li = document.createElement('li');
        li.innerHTML = `<a href="${link.url}" target="${link.target}" ${link.rel?('rel="'+link.rel+'"'):''} class="flex items-center gap-2 hover:underline"><i class="fas fa-fire text-orange-500"></i><span class="line-clamp-1">${item.title}</span></a>`;
        ul.appendChild(li);
      });
    }

    // ================== 搜索与渲染管线 ==================
    const state = { keyword: '', tag: '' };
    function applyPinArticle(news){
      const pinned = (news||[]).find(it => it.pinned);
      const latest = pinned || (sortByDateDesc(news)[0] || news[0]);
      if (!latest) return;
      document.getElementById('pin-title').textContent = latest.title;
      document.getElementById('pin-summary').textContent = latest.summary || '';
      const coverEl = document.getElementById('pin-cover');
      if (coverEl) {
        if (latest.cover) {
          coverEl.innerHTML = `<img src="${latest.cover}" alt="${latest.title}" class="w-full h-full object-cover">`;
        } else {
          coverEl.innerHTML = '<i class="fas fa-newspaper text-gray-400 text-4xl"></i>';
        }
      }
      const link = buildDetailLink(latest);
      const a = document.getElementById('pin-link'); a.href = link.url; a.target = link.target; if (link.rel) a.rel = link.rel;
    }

    function filterNews(base){
      return base.filter(it => {
        const ok1 = state.keyword ? ((it.title||'').includes(state.keyword) || (it.summary||'').includes(state.keyword)) : true;
        const ok2 = state.tag ? (Array.isArray(it.tags) && it.tags.includes(state.tag)) : true;
        return ok1 && ok2;
      });
    }

    function renderAll(){
      const all = readNews();
      const filtered = filterNews(all);
      // 左侧三板块
      const latest = sortByDateDesc(filtered).slice(0,4);
      const hot = sortByHeatDesc(filtered).slice(0,4);
      const timeline = sortByDateDesc(filtered).slice(0,8);
      renderGrid('grid-latest', latest, 4);
      renderGrid('grid-hot', hot, 4);
      renderGrid('grid-timeline', timeline, 8);
      // 置顶文章
      applyPinArticle(filtered.length ? filtered : all);
      // 右侧热门列表根据热度
      renderSideHotList(sortByHeatDesc(filtered.length?filtered:all));
    }

    function initSearch(){
      const input = document.getElementById('search-input');
      const btnClear = document.getElementById('search-clear');
      input.addEventListener('input', function(){ state.keyword = this.value.trim(); renderAll(); });
      btnClear.addEventListener('click', function(){ state.keyword=''; input.value=''; renderAll(); });
    }

    async function syncNewsFromJson(){
      try {
        const r = await fetch('data/news/blog.json');
        let arr = await r.json();

        function getBlogSrcFromHref(href){
          try { const u = new URL(href, location.origin); return decodeURIComponent(u.searchParams.get('src') || ''); } catch { return ''; }
        }
        async function resolveCoverFromItem(item){
          if (item.cover) return item.cover;
          const srcPath = getBlogSrcFromHref(item.href || '');
          if (!srcPath) return '';
          try {
            const rr = await fetch(srcPath);
            const html = await rr.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const main = doc.querySelector('main') || doc.querySelector('article') || doc.body;
            const img = main ? main.querySelector('img') : null;
            let s = img ? (img.getAttribute('src') || '') : '';
            if (!s) return '';
            try { s = new URL(s, srcPath).href; } catch {}
            return s;
          } catch { return ''; }
        }

        arr = await Promise.all(arr.map(async it => {
          const cover = await resolveCoverFromItem(it);
          if (cover) it.cover = cover;
          return it;
        }));

        const now = Date.now();
        const base = JSON.parse(localStorage.getItem(LS_NEWS_KEY) || '[]');
        const other = base.filter(it => !(String(it.id||'').startsWith('blog-')));
        const merged = other.concat(arr);
        localStorage.setItem(LS_NEWS_KEY, JSON.stringify(merged));
        localStorage.setItem('news_blog_synced', String(now));
      } catch {}
    }

    // ================== 初始化 ==================
    document.addEventListener('DOMContentLoaded', function(){
      syncNewsFromJson().then(renderAll);
      renderSideAuthor();
      renderSideTags(tag => { state.tag = tag; renderAll(); });
      initSearch();
      renderAll();
      // 监听 storage 变化以实时联动后台维护的 home_news 与侧边栏配置
      window.addEventListener('storage', function(e){
        if (e.key === LS_NEWS_KEY) renderAll();
        if (e.key === 'news_side_author' || e.key === 'news_side_guests' || e.key === 'news_side_tags') {
          renderSideAuthor(); renderSideTags(tag => { state.tag = tag; renderAll(); });
        }
      });
      setInterval(renderAll, 1500);
    });
  </script>
</body>
</html>